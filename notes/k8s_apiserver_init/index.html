<!doctype html><html lang=zh-cn itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Kubernetes源码分析之kube-apiserver - 钰的笔记屋</title>
<meta name=description content="Kubernetes源码分析之kube-apiserver 简略介绍 本节所有的代码基于最新的v1.18.4版本。 涉及到模块： /cmd/kube-apiserver /pkg/master apiserver /pkg/registry auth 注：ap">
<meta name=author content="钰"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"钰的笔记屋","url":"https:\/\/xyslion.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/xyslion.github.io\/"}</script>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/xyslion.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/xyslion.github.io\/notes\/k8s_apiserver_init\/","name":"Kubernetes源码分析之kube apiserver"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"钰"},"headline":"Kubernetes源码分析之kube-apiserver","description":"Kubernetes源码分析之kube-apiserver 简略介绍 本节所有的代码基于最新的v1.18.4版本。 涉及到模块： \/cmd\/kube-apiserver \/pkg\/master apiserver \/pkg\/registry auth 注：ap","inLanguage":"zh-cn","wordCount":10385,"datePublished":"2020-06-19T11:04:25","dateModified":"2020-06-19T11:04:25","image":"https:\/\/xyslion.github.io\/img\/yu.jpeg","keywords":["k8s, apiserver"],"mainEntityOfPage":"https:\/\/xyslion.github.io\/notes\/k8s_apiserver_init\/","publisher":{"@type":"Organization","name":"https:\/\/xyslion.github.io\/","logo":{"@type":"ImageObject","url":"https:\/\/xyslion.github.io\/img\/yu.jpeg","height":60,"width":60}}}</script>
<meta property="og:title" content="Kubernetes源码分析之kube-apiserver">
<meta property="og:description" content="Kubernetes源码分析之kube-apiserver 简略介绍 本节所有的代码基于最新的v1.18.4版本。 涉及到模块： /cmd/kube-apiserver /pkg/master apiserver /pkg/registry auth 注：ap">
<meta property="og:image" content="https://xyslion.github.io/img/yu.jpeg">
<meta property="og:url" content="https://xyslion.github.io/notes/k8s_apiserver_init/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="钰的笔记屋">
<meta name=twitter:title content="Kubernetes源码分析之kube-apiserver">
<meta name=twitter:description content="Kubernetes源码分析之kube-apiserver 简略介绍 本节所有的代码基于最新的v1.18.4版本。 涉及到模块： /cmd/kube-apiserver /pkg/master apiserver /pkg/registry auth 注：ap">
<meta name=twitter:image content="https://xyslion.github.io/img/yu.jpeg">
<meta name=twitter:card content="summary">
<link href=https://xyslion.github.io/img/favicon.ico rel=icon type=image/x-icon>
<meta name=generator content="Hugo 0.90.1">
<link rel=alternate href=https://xyslion.github.io/index.xml type=application/rss+xml title=钰的笔记屋><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous>
<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://xyslion.github.io/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">
<link rel=stylesheet href=https://xyslion.github.io/css/highlight.min.css><link rel=stylesheet href=https://xyslion.github.io/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top navbar-custom">
<div class=container-fluid>
<div class=navbar-header>
<button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>切换导航</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://xyslion.github.io/>钰的笔记屋</a>
</div>
<div class="collapse navbar-collapse" id=main-navbar>
<ul class="nav navbar-nav navbar-right">
<li>
<a title=首页 href=/>首页</a>
</li>
<li>
<a title=笔记 href=/notes/>笔记</a>
</li>
<li>
<a title=标签 href=/tags/>标签</a>
</li>
<li>
<a title=分类 href=/categories/>分类</a>
</li>
</ul>
</div>
<div class=avatar-container>
<div class=avatar-img-border>
<a title=钰的笔记屋 href=https://xyslion.github.io/>
<img class=avatar-img src=https://xyslion.github.io/img/yu.jpeg alt=钰的笔记屋>
</a>
</div>
</div>
</div>
</nav>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header class=header-section>
<div class="intro-header no-img">
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<div class=notes-heading>
<h1>Kubernetes源码分析之kube-apiserver</h1>
<hr class=small>
</div>
</div>
</div>
</div>
</div>
</header>
<div class=container role=main>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<article role=main class=blog-post>
<h2 id=kubernetes源码分析之kube-apiserver>Kubernetes源码分析之kube-apiserver</h2>
<h3 id=简略介绍>简略介绍</h3>
<p>本节所有的代码基于最新的v1.18.4版本。</p>
<p>涉及到模块：</p>
<ul>
<li><a href=https://github.com/kubernetes/kubernetes/tree/v1.18.4/cmd/kube-apiserver>/cmd/kube-apiserver</a></li>
<li><a href=https://github.com/kubernetes/kubernetes/tree/v1.18.4/pkg/master>/pkg/master</a></li>
<li><a href=https://github.com/kubernetes/kubernetes/tree/v1.18.4/staging/src/k8s.io/apiserver>apiserver</a></li>
<li><a href=https://github.com/kubernetes/kubernetes/tree/v1.18.4/pkg/registry>/pkg/registry</a></li>
<li><a href=https://github.com/kubernetes/kubernetes/tree/v1.18.4/plugin/pkg/auth>auth</a></li>
</ul>
<p><strong>注：apiserver为kubernetes里的另一个project，但这里使用go module的replace功能重定向了kubernetes工程里的staging/src/k8s.io/apiserver里, 两处代码同步机制待研究</strong></p>
<h3 id=启动分析>启动分析</h3>
<p>同Kubernetes所有的组件启动代码一致，apiserver启动使用的是cobra的命令行方式，代码位于<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L102>~/cmd/kube-apiserver/app/server.go</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>RunE</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=nx>verflag</span><span class=p>.</span><span class=nf>PrintAndExitIfRequested</span><span class=p>()</span>
    <span class=nx>utilflag</span><span class=p>.</span><span class=nf>PrintFlags</span><span class=p>(</span><span class=nx>cmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>())</span>

    <span class=c1>// set default options
</span><span class=c1></span>    <span class=nx>completedOptions</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>Complete</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>err</span>
    <span class=p>}</span>

    <span class=c1>// validate options
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>errs</span> <span class=o>:=</span> <span class=nx>completedOptions</span><span class=p>.</span><span class=nf>Validate</span><span class=p>();</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>utilerrors</span><span class=p>.</span><span class=nf>NewAggregate</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>completedOptions</span><span class=p>,</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nf>SetupSignalHandler</span><span class=p>())</span>
<span class=p>},</span>
</code></pre></div><p>启动主要完成三个步骤：
1、完成参数的配置；
2、判断配置是否合法；
3、执行最终的Run方法。</p>
<p><a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L146>Run</a>方法的实现：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Run runs the specified APIServer.  This should never exit.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>completeOptions</span> <span class=nx>completedServerRunOptions</span><span class=p>,</span> <span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
	<span class=c1>// To help debugging, immediately log version
</span><span class=c1></span>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Version: %+v&#34;</span><span class=p>,</span> <span class=nx>version</span><span class=p>.</span><span class=nf>Get</span><span class=p>())</span>

	<span class=nx>server</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>CreateServerChain</span><span class=p>(</span><span class=nx>completeOptions</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=nx>prepared</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>PrepareRun</span><span class=p>()</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=nx>prepared</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>主要执行两个步骤：
1、创建server端；
2、启动server。
因为apiserver本质上就是一个server服务器，所有代码核心就是如何配置server，包括路由、访问权限以及同数据库（etcd）的交互等。先看一下server端是如何创建起来的</p>
<h3 id=server端创建>Server端创建</h3>
<p>Server端的创建集中在<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L164>CreateServerChain</a>方法。方法代码如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// CreateServerChain creates the apiservers connected via delegation.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>CreateServerChain</span><span class=p>(</span><span class=nx>completedOptions</span> <span class=nx>completedServerRunOptions</span><span class=p>,</span> <span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>(</span><span class=o>*</span><span class=nx>aggregatorapiserver</span><span class=p>.</span><span class=nx>APIAggregator</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>nodeTunneler</span><span class=p>,</span> <span class=nx>proxyTransport</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>CreateNodeDialer</span><span class=p>(</span><span class=nx>completedOptions</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=nx>kubeAPIServerConfig</span><span class=p>,</span> <span class=nx>insecureServingInfo</span><span class=p>,</span> <span class=nx>serviceResolver</span><span class=p>,</span> <span class=nx>pluginInitializer</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>CreateKubeAPIServerConfig</span><span class=p>(</span><span class=nx>completedOptions</span><span class=p>,</span> <span class=nx>nodeTunneler</span><span class=p>,</span> <span class=nx>proxyTransport</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=c1>// If additional API servers are added, they should be gated.
</span><span class=c1></span>	<span class=nx>apiExtensionsConfig</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>createAPIExtensionsConfig</span><span class=p>(</span><span class=o>*</span><span class=nx>kubeAPIServerConfig</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>,</span> <span class=nx>kubeAPIServerConfig</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>VersionedInformers</span><span class=p>,</span> <span class=nx>pluginInitializer</span><span class=p>,</span> <span class=nx>completedOptions</span><span class=p>.</span><span class=nx>ServerRunOptions</span><span class=p>,</span> <span class=nx>completedOptions</span><span class=p>.</span><span class=nx>MasterCount</span><span class=p>,</span>
		<span class=nx>serviceResolver</span><span class=p>,</span> <span class=nx>webhook</span><span class=p>.</span><span class=nf>NewDefaultAuthenticationInfoResolverWrapper</span><span class=p>(</span><span class=nx>proxyTransport</span><span class=p>,</span> <span class=nx>kubeAPIServerConfig</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>EgressSelector</span><span class=p>,</span> <span class=nx>kubeAPIServerConfig</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>LoopbackClientConfig</span><span class=p>))</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nx>apiExtensionsServer</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>createAPIExtensionsServer</span><span class=p>(</span><span class=nx>apiExtensionsConfig</span><span class=p>,</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nf>NewEmptyDelegate</span><span class=p>())</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=nx>kubeAPIServer</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>CreateKubeAPIServer</span><span class=p>(</span><span class=nx>kubeAPIServerConfig</span><span class=p>,</span> <span class=nx>apiExtensionsServer</span><span class=p>.</span><span class=nx>GenericAPIServer</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=c1>// aggregator comes last in the chain
</span><span class=c1></span>	<span class=nx>aggregatorConfig</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>createAggregatorConfig</span><span class=p>(</span><span class=o>*</span><span class=nx>kubeAPIServerConfig</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>,</span> <span class=nx>completedOptions</span><span class=p>.</span><span class=nx>ServerRunOptions</span><span class=p>,</span> <span class=nx>kubeAPIServerConfig</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>VersionedInformers</span><span class=p>,</span> <span class=nx>serviceResolver</span><span class=p>,</span> <span class=nx>proxyTransport</span><span class=p>,</span> <span class=nx>pluginInitializer</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nx>aggregatorServer</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>createAggregatorServer</span><span class=p>(</span><span class=nx>aggregatorConfig</span><span class=p>,</span> <span class=nx>kubeAPIServer</span><span class=p>.</span><span class=nx>GenericAPIServer</span><span class=p>,</span> <span class=nx>apiExtensionsServer</span><span class=p>.</span><span class=nx>Informers</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=c1>// we don&#39;t need special handling for innerStopCh because the aggregator server doesn&#39;t create any go routines
</span><span class=c1></span>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>insecureServingInfo</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>insecureHandlerChain</span> <span class=o>:=</span> <span class=nx>kubeserver</span><span class=p>.</span><span class=nf>BuildInsecureHandlerChain</span><span class=p>(</span><span class=nx>aggregatorServer</span><span class=p>.</span><span class=nx>GenericAPIServer</span><span class=p>.</span><span class=nf>UnprotectedHandler</span><span class=p>(),</span> <span class=nx>kubeAPIServerConfig</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>insecureServingInfo</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>insecureHandlerChain</span><span class=p>,</span> <span class=nx>kubeAPIServerConfig</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>RequestTimeout</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
		<span class=p>}</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=nx>aggregatorServer</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>创建过程主要有以下步骤：
1、根据配置构造apiserver的配置，调用方法<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L268>CreateKubeAPIServerConfig</a>；
2、根据配置构造扩展的apiserver的配置，调用方法为<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/apiextensions.go#L40>createAPIExtensionsConfig</a>；
3、创建server，包括扩展的apiserver和原生的apiserver，调用方法为<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/apiextensions.go#L101>createAPIExtensionsServer</a>和<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L213>CreateKubeAPIServer</a>。主要就是将各个handler的路由方法注册到Container中去，完全遵循<a href=http://ernestmicklei.com/2012/11/go-restful-api-design/>go-restful的设计模式</a>，即将处理方法注册到Route中去，同一个根路径下的Route注册到WebService中去，WebService注册到Container中，Container负责分发。访问的过程为Container&ndash;>WebService&ndash;>Route。更加详细的go-restful使用可以参考其代码；
4、聚合server的配置和和创建。主要就是将原生的apiserver和扩展的apiserver的访问进行整合，添加后续的一些处理接口。调用方法为<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/aggregator.go#L57>createAggregatorConfig</a>和<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/aggregator.go#L129>createAggregatorServer</a>；
5、创建完成，返回配置的server信息。
以上几个步骤，最核心的就是apiserver如何创建，即如何按照go-restful的模式，添加路由和相应的处理方法，以<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L213>CreateKubeAPIServer</a>方法为例，<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/aggregator.go#L129>createAPIExtensionsServer</a>类似。</p>
<h4 id=createkubeapiserverhttpsgithubcomkuberneteskubernetesblobv1184cmdkube-apiserverappservergol213><a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L213>CreateKubeAPIServer</a></h4>
<p>源码如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// CreateKubeAPIServer creates and wires a workable kube-apiserver
</span><span class=c1></span><span class=kd>func</span> <span class=nf>CreateKubeAPIServer</span><span class=p>(</span><span class=nx>kubeAPIServerConfig</span> <span class=o>*</span><span class=nx>master</span><span class=p>.</span><span class=nx>Config</span><span class=p>,</span> <span class=nx>delegateAPIServer</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>DelegationTarget</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>master</span><span class=p>.</span><span class=nx>Master</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>kubeAPIServer</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>kubeAPIServerConfig</span><span class=p>.</span><span class=nf>Complete</span><span class=p>().</span><span class=nf>New</span><span class=p>(</span><span class=nx>delegateAPIServer</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=nx>kubeAPIServer</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>通过<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L286>Complete</a>方法完成配置的最终合法化，<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L336>New</a>方法生成kubeAPIServer的配置，进入New方法:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// New returns a new instance of Master from the given config.
</span><span class=c1>// Certain config fields will be set to a default value if unset.
</span><span class=c1>// Certain config fields must be specified, including:
</span><span class=c1>//   KubeletClientConfig
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=nx>completedConfig</span><span class=p>)</span> <span class=nf>New</span><span class=p>(</span><span class=nx>delegationTarget</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>DelegationTarget</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Master</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>if</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>DeepEqual</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>KubeletClientConfig</span><span class=p>,</span> <span class=nx>kubeletclient</span><span class=p>.</span><span class=nx>KubeletClientConfig</span><span class=p>{})</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Master.New() called with empty config.KubeletClientConfig&#34;</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;kube-apiserver&#34;</span><span class=p>,</span> <span class=nx>delegationTarget</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>EnableLogsSupport</span> <span class=p>{</span>
		<span class=nx>routes</span><span class=p>.</span><span class=nx>Logs</span><span class=p>{}.</span><span class=nf>Install</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Handler</span><span class=p>.</span><span class=nx>GoRestfulContainer</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>ServiceAccountIssuerDiscovery</span><span class=p>)</span> <span class=p>{</span>
		<span class=c1>// Metadata and keys are expected to only change across restarts at present,
</span><span class=c1></span>		<span class=c1>// so we just marshal immediately and serve the cached JSON bytes.
</span><span class=c1></span>		<span class=nx>md</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>serviceaccount</span><span class=p>.</span><span class=nf>NewOpenIDMetadata</span><span class=p>(</span>
			<span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceAccountIssuerURL</span><span class=p>,</span>
			<span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceAccountJWKSURI</span><span class=p>,</span>
			<span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>ExternalAddress</span><span class=p>,</span>
			<span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceAccountPublicKeys</span><span class=p>,</span>
		<span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=c1>// If there was an error, skip installing the endpoints and log the
</span><span class=c1></span>			<span class=c1>// error, but continue on. We don&#39;t return the error because the
</span><span class=c1></span>			<span class=c1>// metadata responses require additional, backwards incompatible
</span><span class=c1></span>			<span class=c1>// validation of command-line options.
</span><span class=c1></span>			<span class=nx>msg</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Could not construct pre-rendered responses for&#34;</span><span class=o>+</span>
				<span class=s>&#34; ServiceAccountIssuerDiscovery endpoints. Endpoints will not be&#34;</span><span class=o>+</span>
				<span class=s>&#34; enabled. Error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
			<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceAccountIssuerURL</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
				<span class=c1>// The user likely expects this feature to be enabled if issuer URL is
</span><span class=c1></span>				<span class=c1>// set and the feature gate is enabled. In the future, if there is no
</span><span class=c1></span>				<span class=c1>// longer a feature gate and issuer URL is not set, the user may not
</span><span class=c1></span>				<span class=c1>// expect this feature to be enabled. We log the former case as an Error
</span><span class=c1></span>				<span class=c1>// and the latter case as an Info.
</span><span class=c1></span>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>msg</span><span class=p>)</span>
			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
				<span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=nx>msg</span><span class=p>)</span>
			<span class=p>}</span>
		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
			<span class=nx>routes</span><span class=p>.</span><span class=nf>NewOpenIDMetadataServer</span><span class=p>(</span><span class=nx>md</span><span class=p>.</span><span class=nx>ConfigJSON</span><span class=p>,</span> <span class=nx>md</span><span class=p>.</span><span class=nx>PublicKeysetJSON</span><span class=p>).</span>
				<span class=nf>Install</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Handler</span><span class=p>.</span><span class=nx>GoRestfulContainer</span><span class=p>)</span>
		<span class=p>}</span>
	<span class=p>}</span>

	<span class=nx>m</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Master</span><span class=p>{</span>
		<span class=nx>GenericAPIServer</span><span class=p>:</span>          <span class=nx>s</span><span class=p>,</span>
		<span class=nx>ClusterAuthenticationInfo</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ClusterAuthenticationInfo</span><span class=p>,</span>
	<span class=p>}</span>

	<span class=c1>// install legacy rest storage
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>APIResourceConfigSource</span><span class=p>.</span><span class=nf>VersionEnabled</span><span class=p>(</span><span class=nx>apiv1</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>legacyRESTStorageProvider</span> <span class=o>:=</span> <span class=nx>corerest</span><span class=p>.</span><span class=nx>LegacyRESTStorageProvider</span><span class=p>{</span>
			<span class=nx>StorageFactory</span><span class=p>:</span>              <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>StorageFactory</span><span class=p>,</span>
			<span class=nx>ProxyTransport</span><span class=p>:</span>              <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ProxyTransport</span><span class=p>,</span>
			<span class=nx>KubeletClientConfig</span><span class=p>:</span>         <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>KubeletClientConfig</span><span class=p>,</span>
			<span class=nx>EventTTL</span><span class=p>:</span>                    <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>EventTTL</span><span class=p>,</span>
			<span class=nx>ServiceIPRange</span><span class=p>:</span>              <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceIPRange</span><span class=p>,</span>
			<span class=nx>SecondaryServiceIPRange</span><span class=p>:</span>     <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>SecondaryServiceIPRange</span><span class=p>,</span>
			<span class=nx>ServiceNodePortRange</span><span class=p>:</span>        <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceNodePortRange</span><span class=p>,</span>
			<span class=nx>LoopbackClientConfig</span><span class=p>:</span>        <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>LoopbackClientConfig</span><span class=p>,</span>
			<span class=nx>ServiceAccountIssuer</span><span class=p>:</span>        <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceAccountIssuer</span><span class=p>,</span>
			<span class=nx>ServiceAccountMaxExpiration</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceAccountMaxExpiration</span><span class=p>,</span>
			<span class=nx>APIAudiences</span><span class=p>:</span>                <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>APIAudiences</span><span class=p>,</span>
		<span class=p>}</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>InstallLegacyAPI</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>RESTOptionsGetter</span><span class=p>,</span> <span class=nx>legacyRESTStorageProvider</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
		<span class=p>}</span>
	<span class=p>}</span>

	<span class=c1>// The order here is preserved in discovery.
</span><span class=c1></span>	<span class=c1>// If resources with identical names exist in more than one of these groups (e.g. &#34;deployments.apps&#34;&#34; and &#34;deployments.extensions&#34;),
</span><span class=c1></span>	<span class=c1>// the order of this list determines which group an unqualified resource name (e.g. &#34;deployments&#34;) should prefer.
</span><span class=c1></span>	<span class=c1>// This priority order is used for local discovery, but it ends up aggregated in `k8s.io/kubernetes/cmd/kube-apiserver/app/aggregator.go
</span><span class=c1></span>	<span class=c1>// with specific priorities.
</span><span class=c1></span>	<span class=c1>// TODO: describe the priority all the way down in the RESTStorageProviders and plumb it back through the various discovery
</span><span class=c1></span>	<span class=c1>// handlers that we have.
</span><span class=c1></span>	<span class=nx>restStorageProviders</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>RESTStorageProvider</span><span class=p>{</span>
		<span class=nx>auditregistrationrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>authenticationrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{</span><span class=nx>Authenticator</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>Authenticator</span><span class=p>,</span> <span class=nx>APIAudiences</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>APIAudiences</span><span class=p>},</span>
		<span class=nx>authorizationrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{</span><span class=nx>Authorizer</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>Authorization</span><span class=p>.</span><span class=nx>Authorizer</span><span class=p>,</span> <span class=nx>RuleResolver</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>RuleResolver</span><span class=p>},</span>
		<span class=nx>autoscalingrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>batchrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>certificatesrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>coordinationrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>discoveryrest</span><span class=p>.</span><span class=nx>StorageProvider</span><span class=p>{},</span>
		<span class=nx>extensionsrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>networkingrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>noderest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>policyrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>rbacrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{</span><span class=nx>Authorizer</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>Authorization</span><span class=p>.</span><span class=nx>Authorizer</span><span class=p>},</span>
		<span class=nx>schedulingrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>settingsrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>storagerest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>flowcontrolrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=c1>// keep apps after extensions so legacy clients resolve the extensions versions of shared resource names.
</span><span class=c1></span>		<span class=c1>// See https://github.com/kubernetes/kubernetes/issues/42392
</span><span class=c1></span>		<span class=nx>appsrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>admissionregistrationrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
		<span class=nx>eventsrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{</span><span class=nx>TTL</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>EventTTL</span><span class=p>},</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>InstallAPIs</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>APIResourceConfigSource</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>RESTOptionsGetter</span><span class=p>,</span> <span class=nx>restStorageProviders</span><span class=o>...</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>Tunneler</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>m</span><span class=p>.</span><span class=nf>installTunneler</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>Tunneler</span><span class=p>,</span> <span class=nx>corev1client</span><span class=p>.</span><span class=nf>NewForConfigOrDie</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>LoopbackClientConfig</span><span class=p>).</span><span class=nf>Nodes</span><span class=p>())</span>
	<span class=p>}</span>

	<span class=nx>m</span><span class=p>.</span><span class=nx>GenericAPIServer</span><span class=p>.</span><span class=nf>AddPostStartHookOrDie</span><span class=p>(</span><span class=s>&#34;start-cluster-authentication-info-controller&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>hookContext</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>PostStartHookContext</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
		<span class=nx>kubeClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>kubernetes</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>hookContext</span><span class=p>.</span><span class=nx>LoopbackClientConfig</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=nx>err</span>
		<span class=p>}</span>
		<span class=nx>controller</span> <span class=o>:=</span> <span class=nx>clusterauthenticationtrust</span><span class=p>.</span><span class=nf>NewClusterAuthenticationTrustController</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>ClusterAuthenticationInfo</span><span class=p>,</span> <span class=nx>kubeClient</span><span class=p>)</span>

		<span class=c1>// prime values and start listeners
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>m</span><span class=p>.</span><span class=nx>ClusterAuthenticationInfo</span><span class=p>.</span><span class=nx>ClientCA</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>if</span> <span class=nx>notifier</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>ClusterAuthenticationInfo</span><span class=p>.</span><span class=nx>ClientCA</span><span class=p>.(</span><span class=nx>dynamiccertificates</span><span class=p>.</span><span class=nx>Notifier</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
				<span class=nx>notifier</span><span class=p>.</span><span class=nf>AddListener</span><span class=p>(</span><span class=nx>controller</span><span class=p>)</span>
			<span class=p>}</span>
			<span class=k>if</span> <span class=nx>controller</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>ClusterAuthenticationInfo</span><span class=p>.</span><span class=nx>ClientCA</span><span class=p>.(</span><span class=nx>dynamiccertificates</span><span class=p>.</span><span class=nx>ControllerRunner</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
				<span class=c1>// runonce to be sure that we have a value.
</span><span class=c1></span>				<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>controller</span><span class=p>.</span><span class=nf>RunOnce</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
					<span class=nx>runtime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
				<span class=p>}</span>
				<span class=k>go</span> <span class=nx>controller</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nx>hookContext</span><span class=p>.</span><span class=nx>StopCh</span><span class=p>)</span>
			<span class=p>}</span>
		<span class=p>}</span>
		<span class=k>if</span> <span class=nx>m</span><span class=p>.</span><span class=nx>ClusterAuthenticationInfo</span><span class=p>.</span><span class=nx>RequestHeaderCA</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>if</span> <span class=nx>notifier</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>ClusterAuthenticationInfo</span><span class=p>.</span><span class=nx>RequestHeaderCA</span><span class=p>.(</span><span class=nx>dynamiccertificates</span><span class=p>.</span><span class=nx>Notifier</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
				<span class=nx>notifier</span><span class=p>.</span><span class=nf>AddListener</span><span class=p>(</span><span class=nx>controller</span><span class=p>)</span>
			<span class=p>}</span>
			<span class=k>if</span> <span class=nx>controller</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>ClusterAuthenticationInfo</span><span class=p>.</span><span class=nx>RequestHeaderCA</span><span class=p>.(</span><span class=nx>dynamiccertificates</span><span class=p>.</span><span class=nx>ControllerRunner</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
				<span class=c1>// runonce to be sure that we have a value.
</span><span class=c1></span>				<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>controller</span><span class=p>.</span><span class=nf>RunOnce</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
					<span class=nx>runtime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
				<span class=p>}</span>
				<span class=k>go</span> <span class=nx>controller</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nx>hookContext</span><span class=p>.</span><span class=nx>StopCh</span><span class=p>)</span>
			<span class=p>}</span>
		<span class=p>}</span>

		<span class=k>go</span> <span class=nx>controller</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nx>hookContext</span><span class=p>.</span><span class=nx>StopCh</span><span class=p>)</span>
		<span class=k>return</span> <span class=kc>nil</span>
	<span class=p>})</span>

	<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>包含以下步骤：
1、按照<code>go-restful</code>的模式，调用<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L523>c.GenericConfig.New</a>方法初始化化Container，即<code>gorestfulContainer</code>，初始方法为<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/handler.go#L73>NewAPIServerHandler</a>。初始化之后，添加路由。</p>
<p>调用<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L688>installAPI</a>方法添加<code>apiserver</code>的基本路由信息</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>installAPI</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>GenericAPIServer</span><span class=p>,</span> <span class=nx>c</span> <span class=o>*</span><span class=nx>Config</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>EnableIndex</span> <span class=p>{</span>
		<span class=nx>routes</span><span class=p>.</span><span class=nx>Index</span><span class=p>{}.</span><span class=nf>Install</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>listedPathProvider</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Handler</span><span class=p>.</span><span class=nx>NonGoRestfulMux</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>EnableProfiling</span> <span class=p>{</span>
		<span class=nx>routes</span><span class=p>.</span><span class=nx>Profiling</span><span class=p>{}.</span><span class=nf>Install</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Handler</span><span class=p>.</span><span class=nx>NonGoRestfulMux</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>EnableContentionProfiling</span> <span class=p>{</span>
			<span class=nx>goruntime</span><span class=p>.</span><span class=nf>SetBlockProfileRate</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
		<span class=p>}</span>
		<span class=c1>// so far, only logging related endpoints are considered valid to add for these debug flags.
</span><span class=c1></span>		<span class=nx>routes</span><span class=p>.</span><span class=nx>DebugFlags</span><span class=p>{}.</span><span class=nf>Install</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Handler</span><span class=p>.</span><span class=nx>NonGoRestfulMux</span><span class=p>,</span> <span class=s>&#34;v&#34;</span><span class=p>,</span> <span class=nx>routes</span><span class=p>.</span><span class=nf>StringFlagPutHandler</span><span class=p>(</span><span class=nx>logs</span><span class=p>.</span><span class=nx>GlogSetter</span><span class=p>))</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>EnableMetrics</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>EnableProfiling</span> <span class=p>{</span>
			<span class=nx>routes</span><span class=p>.</span><span class=nx>MetricsWithReset</span><span class=p>{}.</span><span class=nf>Install</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Handler</span><span class=p>.</span><span class=nx>NonGoRestfulMux</span><span class=p>)</span>
		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
			<span class=nx>routes</span><span class=p>.</span><span class=nx>DefaultMetrics</span><span class=p>{}.</span><span class=nf>Install</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Handler</span><span class=p>.</span><span class=nx>NonGoRestfulMux</span><span class=p>)</span>
		<span class=p>}</span>
	<span class=p>}</span>

	<span class=nx>routes</span><span class=p>.</span><span class=nx>Version</span><span class=p>{</span><span class=nx>Version</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Version</span><span class=p>}.</span><span class=nf>Install</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Handler</span><span class=p>.</span><span class=nx>GoRestfulContainer</span><span class=p>)</span>

	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>EnableDiscovery</span> <span class=p>{</span>
		<span class=nx>s</span><span class=p>.</span><span class=nx>Handler</span><span class=p>.</span><span class=nx>GoRestfulContainer</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>DiscoveryGroupManager</span><span class=p>.</span><span class=nf>WebService</span><span class=p>())</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>该方法中添加了包括/、/debug/*、/metrics、/version几条路由，通过访问apiserver即可看到相关的信息</p>
<p>2、判断是否支持logs相关的路由，如果支持，则添加/logs路由；
3、添加<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L389>以api开头的路由</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// install legacy rest storage
</span><span class=c1></span><span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>APIResourceConfigSource</span><span class=p>.</span><span class=nf>VersionEnabled</span><span class=p>(</span><span class=nx>apiv1</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>legacyRESTStorageProvider</span> <span class=o>:=</span> <span class=nx>corerest</span><span class=p>.</span><span class=nx>LegacyRESTStorageProvider</span><span class=p>{</span>
		<span class=nx>StorageFactory</span><span class=p>:</span>              <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>StorageFactory</span><span class=p>,</span>
		<span class=nx>ProxyTransport</span><span class=p>:</span>              <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ProxyTransport</span><span class=p>,</span>
		<span class=nx>KubeletClientConfig</span><span class=p>:</span>         <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>KubeletClientConfig</span><span class=p>,</span>
		<span class=nx>EventTTL</span><span class=p>:</span>                    <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>EventTTL</span><span class=p>,</span>
		<span class=nx>ServiceIPRange</span><span class=p>:</span>              <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceIPRange</span><span class=p>,</span>
		<span class=nx>SecondaryServiceIPRange</span><span class=p>:</span>     <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>SecondaryServiceIPRange</span><span class=p>,</span>
		<span class=nx>ServiceNodePortRange</span><span class=p>:</span>        <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceNodePortRange</span><span class=p>,</span>
		<span class=nx>LoopbackClientConfig</span><span class=p>:</span>        <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>LoopbackClientConfig</span><span class=p>,</span>
		<span class=nx>ServiceAccountIssuer</span><span class=p>:</span>        <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceAccountIssuer</span><span class=p>,</span>
		<span class=nx>ServiceAccountMaxExpiration</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>ServiceAccountMaxExpiration</span><span class=p>,</span>
		<span class=nx>APIAudiences</span><span class=p>:</span>                <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>APIAudiences</span><span class=p>,</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>InstallLegacyAPI</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>RESTOptionsGetter</span><span class=p>,</span> <span class=nx>legacyRESTStorageProvider</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>在集群中对应的路由有<code>/api、/api/v1</code>, 比较常用的资源像Pods就是该路由对应的资源；</p>
<p>4、添加<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L415>以apis开头的路由</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// The order here is preserved in discovery.
</span><span class=c1>// If resources with identical names exist in more than one of these groups (e.g. &#34;deployments.apps&#34;&#34; and &#34;deployments.extensions&#34;),
</span><span class=c1>// the order of this list determines which group an unqualified resource name (e.g. &#34;deployments&#34;) should prefer.
</span><span class=c1>// This priority order is used for local discovery, but it ends up aggregated in `k8s.io/kubernetes/cmd/kube-apiserver/app/aggregator.go
</span><span class=c1>// with specific priorities.
</span><span class=c1>// TODO: describe the priority all the way down in the RESTStorageProviders and plumb it back through the various discovery
</span><span class=c1>// handlers that we have.
</span><span class=c1></span><span class=nx>restStorageProviders</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>RESTStorageProvider</span><span class=p>{</span>
	<span class=nx>auditregistrationrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>authenticationrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{</span><span class=nx>Authenticator</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>Authenticator</span><span class=p>,</span> <span class=nx>APIAudiences</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>APIAudiences</span><span class=p>},</span>
	<span class=nx>authorizationrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{</span><span class=nx>Authorizer</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>Authorization</span><span class=p>.</span><span class=nx>Authorizer</span><span class=p>,</span> <span class=nx>RuleResolver</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>RuleResolver</span><span class=p>},</span>
	<span class=nx>autoscalingrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>batchrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>certificatesrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>coordinationrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>discoveryrest</span><span class=p>.</span><span class=nx>StorageProvider</span><span class=p>{},</span>
	<span class=nx>extensionsrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>networkingrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>noderest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>policyrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>rbacrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{</span><span class=nx>Authorizer</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>Authorization</span><span class=p>.</span><span class=nx>Authorizer</span><span class=p>},</span>
	<span class=nx>schedulingrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>settingsrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>storagerest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>flowcontrolrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=c1>// keep apps after extensions so legacy clients resolve the extensions versions of shared resource names.
</span><span class=c1></span>	<span class=c1>// See https://github.com/kubernetes/kubernetes/issues/42392
</span><span class=c1></span>	<span class=nx>appsrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>admissionregistrationrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{},</span>
	<span class=nx>eventsrest</span><span class=p>.</span><span class=nx>RESTStorageProvider</span><span class=p>{</span><span class=nx>TTL</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>EventTTL</span><span class=p>},</span>
<span class=p>}</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nf>InstallAPIs</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>APIResourceConfigSource</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>RESTOptionsGetter</span><span class=p>,</span> <span class=nx>restStorageProviders</span><span class=o>...</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>Tunneler</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=nx>m</span><span class=p>.</span><span class=nf>installTunneler</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>ExtraConfig</span><span class=p>.</span><span class=nx>Tunneler</span><span class=p>,</span> <span class=nx>corev1client</span><span class=p>.</span><span class=nf>NewForConfigOrDie</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>LoopbackClientConfig</span><span class=p>).</span><span class=nf>Nodes</span><span class=p>())</span>
<span class=p>}</span>
</code></pre></div><p>在集群中对应的路由有<code>/apis</code>开头的请求, 可以看到apis开头的路由明显较多。应该是由于kubernetes设计之初的版本都是以api/v1开头，后续扩展的版本以apis开头命名。现在更多的是通过CRD与自定义Controller的方法扩展API，不再进行api版本的扩展。基本上代码中的名称都可以在实际集群中找到对应的API。</p>
<h4 id=路由添加api开头>路由添加(api开头)</h4>
<p>api开头的路由通过<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L487>InstallLegacyAPI</a>方法添加。进入<code>InstallLegacyAPI</code>方法，如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// InstallLegacyAPI will install the legacy APIs for the restStorageProviders if they are enabled.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>Master</span><span class=p>)</span> <span class=nf>InstallLegacyAPI</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>completedConfig</span><span class=p>,</span> <span class=nx>restOptionsGetter</span> <span class=nx>generic</span><span class=p>.</span><span class=nx>RESTOptionsGetter</span><span class=p>,</span> <span class=nx>legacyRESTStorageProvider</span> <span class=nx>corerest</span><span class=p>.</span><span class=nx>LegacyRESTStorageProvider</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
	<span class=nx>legacyRESTStorage</span><span class=p>,</span> <span class=nx>apiGroupInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>legacyRESTStorageProvider</span><span class=p>.</span><span class=nf>NewLegacyRESTStorage</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error building core storage: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>controllerName</span> <span class=o>:=</span> <span class=s>&#34;bootstrap-controller&#34;</span>
	<span class=nx>coreClient</span> <span class=o>:=</span> <span class=nx>corev1client</span><span class=p>.</span><span class=nf>NewForConfigOrDie</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>GenericConfig</span><span class=p>.</span><span class=nx>LoopbackClientConfig</span><span class=p>)</span>
	<span class=nx>bootstrapController</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>NewBootstrapController</span><span class=p>(</span><span class=nx>legacyRESTStorage</span><span class=p>,</span> <span class=nx>coreClient</span><span class=p>,</span> <span class=nx>coreClient</span><span class=p>,</span> <span class=nx>coreClient</span><span class=p>,</span> <span class=nx>coreClient</span><span class=p>.</span><span class=nf>RESTClient</span><span class=p>())</span>
	<span class=nx>m</span><span class=p>.</span><span class=nx>GenericAPIServer</span><span class=p>.</span><span class=nf>AddPostStartHookOrDie</span><span class=p>(</span><span class=nx>controllerName</span><span class=p>,</span> <span class=nx>bootstrapController</span><span class=p>.</span><span class=nx>PostStartHook</span><span class=p>)</span>
	<span class=nx>m</span><span class=p>.</span><span class=nx>GenericAPIServer</span><span class=p>.</span><span class=nf>AddPreShutdownHookOrDie</span><span class=p>(</span><span class=nx>controllerName</span><span class=p>,</span> <span class=nx>bootstrapController</span><span class=p>.</span><span class=nx>PreShutdownHook</span><span class=p>)</span>

	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>m</span><span class=p>.</span><span class=nx>GenericAPIServer</span><span class=p>.</span><span class=nf>InstallLegacyAPIGroup</span><span class=p>(</span><span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>DefaultLegacyAPIPrefix</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>apiGroupInfo</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error in registering group versions: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>通过<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/registry/core/rest/storage_core.go#L102>NewLegacyRESTStorage</a>方法创建各个资源的RESTStorage。RESTStorage是一个结构体，具体的实现了<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L81>Store</a>接口，结构体内主要包含<code>NewFunc</code>返回特定资源信息、<code>NewListFunc</code>返回特定资源列表、<code>CreateStrategy</code>特定资源创建时的策略、<code>UpdateStrategy</code>更新时的策略以及<code>DeleteStrategy</code>删除时的策略等重要方法。
在<code>NewLegacyRESTStorage</code>内部，可以看到创建了多种资源的RESTStorage</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>podTemplateStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>podtemplatestore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=nx>eventStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>eventstore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>,</span> <span class=nb>uint64</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>EventTTL</span><span class=p>.</span><span class=nf>Seconds</span><span class=p>()))</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>
<span class=nx>limitRangeStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>limitrangestore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=nx>resourceQuotaStorage</span><span class=p>,</span> <span class=nx>resourceQuotaStatusStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>resourcequotastore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>
<span class=nx>secretStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>secretstore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>
<span class=nx>persistentVolumeStorage</span><span class=p>,</span> <span class=nx>persistentVolumeStatusStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pvstore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>
<span class=nx>persistentVolumeClaimStorage</span><span class=p>,</span> <span class=nx>persistentVolumeClaimStatusStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pvcstore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>
<span class=nx>configMapStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>configmapstore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=nx>namespaceStorage</span><span class=p>,</span> <span class=nx>namespaceStatusStorage</span><span class=p>,</span> <span class=nx>namespaceFinalizeStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>namespacestore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=nx>endpointsStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>endpointsstore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=nx>nodeStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>nodestore</span><span class=p>.</span><span class=nf>NewStorage</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>KubeletClientConfig</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ProxyTransport</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=nx>podStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>podstore</span><span class=p>.</span><span class=nf>NewStorage</span><span class=p>(</span>
	<span class=nx>restOptionsGetter</span><span class=p>,</span>
	<span class=nx>nodeStorage</span><span class=p>.</span><span class=nx>KubeletConnectionInfo</span><span class=p>,</span>
	<span class=nx>c</span><span class=p>.</span><span class=nx>ProxyTransport</span><span class=p>,</span>
	<span class=nx>podDisruptionClient</span><span class=p>,</span>
<span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>serviceAccountStorage</span> <span class=o>*</span><span class=nx>serviceaccountstore</span><span class=p>.</span><span class=nx>REST</span>
<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ServiceAccountIssuer</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>TokenRequest</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>serviceAccountStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>serviceaccountstore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ServiceAccountIssuer</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>APIAudiences</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ServiceAccountMaxExpiration</span><span class=p>,</span> <span class=nx>podStorage</span><span class=p>.</span><span class=nx>Pod</span><span class=p>.</span><span class=nx>Store</span><span class=p>,</span> <span class=nx>secretStorage</span><span class=p>.</span><span class=nx>Store</span><span class=p>)</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
	<span class=nx>serviceAccountStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>serviceaccountstore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
<span class=p>}</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=nx>serviceRESTStorage</span><span class=p>,</span> <span class=nx>serviceStatusStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>servicestore</span><span class=p>.</span><span class=nf>NewGenericREST</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>serviceClusterIPRegistry</span> <span class=nx>rangeallocation</span><span class=p>.</span><span class=nx>RangeRegistry</span>
<span class=nx>serviceClusterIPRange</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>ServiceIPRange</span>
<span class=k>if</span> <span class=nx>serviceClusterIPRange</span><span class=p>.</span><span class=nx>IP</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;service clusterIPRange is missing&#34;</span><span class=p>)</span>
<span class=p>}</span>

<span class=nx>serviceStorageConfig</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>StorageFactory</span><span class=p>.</span><span class=nf>NewConfig</span><span class=p>(</span><span class=nx>api</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=s>&#34;services&#34;</span><span class=p>))</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=nx>serviceClusterIPAllocator</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ipallocator</span><span class=p>.</span><span class=nf>NewAllocatorCIDRRange</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>serviceClusterIPRange</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>max</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>rangeSpec</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>allocator</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>mem</span> <span class=o>:=</span> <span class=nx>allocator</span><span class=p>.</span><span class=nf>NewAllocationMap</span><span class=p>(</span><span class=nx>max</span><span class=p>,</span> <span class=nx>rangeSpec</span><span class=p>)</span>
	<span class=c1>// TODO etcdallocator package to return a storage interface via the storageFactory
</span><span class=c1></span>	<span class=nx>etcd</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>serviceallocator</span><span class=p>.</span><span class=nf>NewEtcd</span><span class=p>(</span><span class=nx>mem</span><span class=p>,</span> <span class=s>&#34;/ranges/serviceips&#34;</span><span class=p>,</span> <span class=nx>api</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=s>&#34;serviceipallocations&#34;</span><span class=p>),</span> <span class=nx>serviceStorageConfig</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nx>serviceClusterIPRegistry</span> <span class=p>=</span> <span class=nx>etcd</span>
	<span class=k>return</span> <span class=nx>etcd</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>})</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;cannot create cluster IP allocator: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
<span class=p>}</span>
<span class=nx>restStorage</span><span class=p>.</span><span class=nx>ServiceClusterIPAllocator</span> <span class=p>=</span> <span class=nx>serviceClusterIPRegistry</span>

<span class=c1>// allocator for secondary service ip range
</span><span class=c1></span><span class=kd>var</span> <span class=nx>secondaryServiceClusterIPAllocator</span> <span class=nx>ipallocator</span><span class=p>.</span><span class=nx>Interface</span>
<span class=k>if</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>IPv6DualStack</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>c</span><span class=p>.</span><span class=nx>SecondaryServiceIPRange</span><span class=p>.</span><span class=nx>IP</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=kd>var</span> <span class=nx>secondaryServiceClusterIPRegistry</span> <span class=nx>rangeallocation</span><span class=p>.</span><span class=nx>RangeRegistry</span>
	<span class=nx>secondaryServiceClusterIPAllocator</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>ipallocator</span><span class=p>.</span><span class=nf>NewAllocatorCIDRRange</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>SecondaryServiceIPRange</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>max</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>rangeSpec</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>allocator</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>mem</span> <span class=o>:=</span> <span class=nx>allocator</span><span class=p>.</span><span class=nf>NewAllocationMap</span><span class=p>(</span><span class=nx>max</span><span class=p>,</span> <span class=nx>rangeSpec</span><span class=p>)</span>
		<span class=c1>// TODO etcdallocator package to return a storage interface via the storageFactory
</span><span class=c1></span>		<span class=nx>etcd</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>serviceallocator</span><span class=p>.</span><span class=nf>NewEtcd</span><span class=p>(</span><span class=nx>mem</span><span class=p>,</span> <span class=s>&#34;/ranges/secondaryserviceips&#34;</span><span class=p>,</span> <span class=nx>api</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=s>&#34;serviceipallocations&#34;</span><span class=p>),</span> <span class=nx>serviceStorageConfig</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
		<span class=p>}</span>
		<span class=nx>secondaryServiceClusterIPRegistry</span> <span class=p>=</span> <span class=nx>etcd</span>
		<span class=k>return</span> <span class=nx>etcd</span><span class=p>,</span> <span class=kc>nil</span>
	<span class=p>})</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;cannot create cluster secondary IP allocator: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>restStorage</span><span class=p>.</span><span class=nx>SecondaryServiceClusterIPAllocator</span> <span class=p>=</span> <span class=nx>secondaryServiceClusterIPRegistry</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>serviceNodePortRegistry</span> <span class=nx>rangeallocation</span><span class=p>.</span><span class=nx>RangeRegistry</span>
<span class=nx>serviceNodePortAllocator</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>portallocator</span><span class=p>.</span><span class=nf>NewPortAllocatorCustom</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>ServiceNodePortRange</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>max</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>rangeSpec</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>allocator</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>mem</span> <span class=o>:=</span> <span class=nx>allocator</span><span class=p>.</span><span class=nf>NewAllocationMap</span><span class=p>(</span><span class=nx>max</span><span class=p>,</span> <span class=nx>rangeSpec</span><span class=p>)</span>
	<span class=c1>// TODO etcdallocator package to return a storage interface via the storageFactory
</span><span class=c1></span>	<span class=nx>etcd</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>serviceallocator</span><span class=p>.</span><span class=nf>NewEtcd</span><span class=p>(</span><span class=nx>mem</span><span class=p>,</span> <span class=s>&#34;/ranges/servicenodeports&#34;</span><span class=p>,</span> <span class=nx>api</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=s>&#34;servicenodeportallocations&#34;</span><span class=p>),</span> <span class=nx>serviceStorageConfig</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nx>serviceNodePortRegistry</span> <span class=p>=</span> <span class=nx>etcd</span>
	<span class=k>return</span> <span class=nx>etcd</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>})</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;cannot create cluster port allocator: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
<span class=p>}</span>
<span class=nx>restStorage</span><span class=p>.</span><span class=nx>ServiceNodePortAllocator</span> <span class=p>=</span> <span class=nx>serviceNodePortRegistry</span>

<span class=nx>controllerStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>controllerstore</span><span class=p>.</span><span class=nf>NewStorage</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>LegacyRESTStorage</span><span class=p>{},</span> <span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>{},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=nx>serviceRest</span><span class=p>,</span> <span class=nx>serviceRestProxy</span> <span class=o>:=</span> <span class=nx>servicestore</span><span class=p>.</span><span class=nf>NewREST</span><span class=p>(</span><span class=nx>serviceRESTStorage</span><span class=p>,</span>
	<span class=nx>endpointsStorage</span><span class=p>,</span>
	<span class=nx>podStorage</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
	<span class=nx>serviceClusterIPAllocator</span><span class=p>,</span>
	<span class=nx>secondaryServiceClusterIPAllocator</span><span class=p>,</span>
	<span class=nx>serviceNodePortAllocator</span><span class=p>,</span>
	<span class=nx>c</span><span class=p>.</span><span class=nx>ProxyTransport</span><span class=p>)</span>
</code></pre></div><p>常见的像event、secret、namespace、endpoints等，统一调用<code>NewREST</code>方法构造相应的资源。待所有资源的store创建完成之后，使用<code>restStorageMap</code>的Map类型将每个资源的路由和对应的store对应起来，方便后续去做路由的统一规划，代码如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>restStorageMap</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>rest</span><span class=p>.</span><span class=nx>Storage</span><span class=p>{</span>
	<span class=s>&#34;pods&#34;</span><span class=p>:</span>             <span class=nx>podStorage</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
	<span class=s>&#34;pods/attach&#34;</span><span class=p>:</span>      <span class=nx>podStorage</span><span class=p>.</span><span class=nx>Attach</span><span class=p>,</span>
	<span class=s>&#34;pods/status&#34;</span><span class=p>:</span>      <span class=nx>podStorage</span><span class=p>.</span><span class=nx>Status</span><span class=p>,</span>
	<span class=s>&#34;pods/log&#34;</span><span class=p>:</span>         <span class=nx>podStorage</span><span class=p>.</span><span class=nx>Log</span><span class=p>,</span>
	<span class=s>&#34;pods/exec&#34;</span><span class=p>:</span>        <span class=nx>podStorage</span><span class=p>.</span><span class=nx>Exec</span><span class=p>,</span>
	<span class=s>&#34;pods/portforward&#34;</span><span class=p>:</span> <span class=nx>podStorage</span><span class=p>.</span><span class=nx>PortForward</span><span class=p>,</span>
	<span class=s>&#34;pods/proxy&#34;</span><span class=p>:</span>       <span class=nx>podStorage</span><span class=p>.</span><span class=nx>Proxy</span><span class=p>,</span>
	<span class=s>&#34;pods/binding&#34;</span><span class=p>:</span>     <span class=nx>podStorage</span><span class=p>.</span><span class=nx>Binding</span><span class=p>,</span>
	<span class=s>&#34;bindings&#34;</span><span class=p>:</span>         <span class=nx>podStorage</span><span class=p>.</span><span class=nx>LegacyBinding</span><span class=p>,</span>

	<span class=s>&#34;podTemplates&#34;</span><span class=p>:</span> <span class=nx>podTemplateStorage</span><span class=p>,</span>

	<span class=s>&#34;replicationControllers&#34;</span><span class=p>:</span>        <span class=nx>controllerStorage</span><span class=p>.</span><span class=nx>Controller</span><span class=p>,</span>
	<span class=s>&#34;replicationControllers/status&#34;</span><span class=p>:</span> <span class=nx>controllerStorage</span><span class=p>.</span><span class=nx>Status</span><span class=p>,</span>

	<span class=s>&#34;services&#34;</span><span class=p>:</span>        <span class=nx>serviceRest</span><span class=p>,</span>
	<span class=s>&#34;services/proxy&#34;</span><span class=p>:</span>  <span class=nx>serviceRestProxy</span><span class=p>,</span>
	<span class=s>&#34;services/status&#34;</span><span class=p>:</span> <span class=nx>serviceStatusStorage</span><span class=p>,</span>

	<span class=s>&#34;endpoints&#34;</span><span class=p>:</span> <span class=nx>endpointsStorage</span><span class=p>,</span>

	<span class=s>&#34;nodes&#34;</span><span class=p>:</span>        <span class=nx>nodeStorage</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span>
	<span class=s>&#34;nodes/status&#34;</span><span class=p>:</span> <span class=nx>nodeStorage</span><span class=p>.</span><span class=nx>Status</span><span class=p>,</span>
	<span class=s>&#34;nodes/proxy&#34;</span><span class=p>:</span>  <span class=nx>nodeStorage</span><span class=p>.</span><span class=nx>Proxy</span><span class=p>,</span>

	<span class=s>&#34;events&#34;</span><span class=p>:</span> <span class=nx>eventStorage</span><span class=p>,</span>

	<span class=s>&#34;limitRanges&#34;</span><span class=p>:</span>                   <span class=nx>limitRangeStorage</span><span class=p>,</span>
	<span class=s>&#34;resourceQuotas&#34;</span><span class=p>:</span>                <span class=nx>resourceQuotaStorage</span><span class=p>,</span>
	<span class=s>&#34;resourceQuotas/status&#34;</span><span class=p>:</span>         <span class=nx>resourceQuotaStatusStorage</span><span class=p>,</span>
	<span class=s>&#34;namespaces&#34;</span><span class=p>:</span>                    <span class=nx>namespaceStorage</span><span class=p>,</span>
	<span class=s>&#34;namespaces/status&#34;</span><span class=p>:</span>             <span class=nx>namespaceStatusStorage</span><span class=p>,</span>
	<span class=s>&#34;namespaces/finalize&#34;</span><span class=p>:</span>           <span class=nx>namespaceFinalizeStorage</span><span class=p>,</span>
	<span class=s>&#34;secrets&#34;</span><span class=p>:</span>                       <span class=nx>secretStorage</span><span class=p>,</span>
	<span class=s>&#34;serviceAccounts&#34;</span><span class=p>:</span>               <span class=nx>serviceAccountStorage</span><span class=p>,</span>
	<span class=s>&#34;persistentVolumes&#34;</span><span class=p>:</span>             <span class=nx>persistentVolumeStorage</span><span class=p>,</span>
	<span class=s>&#34;persistentVolumes/status&#34;</span><span class=p>:</span>      <span class=nx>persistentVolumeStatusStorage</span><span class=p>,</span>
	<span class=s>&#34;persistentVolumeClaims&#34;</span><span class=p>:</span>        <span class=nx>persistentVolumeClaimStorage</span><span class=p>,</span>
	<span class=s>&#34;persistentVolumeClaims/status&#34;</span><span class=p>:</span> <span class=nx>persistentVolumeClaimStatusStorage</span><span class=p>,</span>
	<span class=s>&#34;configMaps&#34;</span><span class=p>:</span>                    <span class=nx>configMapStorage</span><span class=p>,</span>

	<span class=s>&#34;componentStatuses&#34;</span><span class=p>:</span> <span class=nx>componentstatus</span><span class=p>.</span><span class=nf>NewStorage</span><span class=p>(</span><span class=nx>componentStatusStorage</span><span class=p>{</span><span class=nx>c</span><span class=p>.</span><span class=nx>StorageFactory</span><span class=p>}.</span><span class=nx>serversToValidate</span><span class=p>),</span>
<span class=p>}</span>

<span class=k>if</span> <span class=nx>legacyscheme</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>.</span><span class=nf>IsVersionRegistered</span><span class=p>(</span><span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersion</span><span class=p>{</span><span class=nx>Group</span><span class=p>:</span> <span class=s>&#34;autoscaling&#34;</span><span class=p>,</span> <span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>})</span> <span class=p>{</span>
	<span class=nx>restStorageMap</span><span class=p>[</span><span class=s>&#34;replicationControllers/scale&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>controllerStorage</span><span class=p>.</span><span class=nx>Scale</span>
<span class=p>}</span>
<span class=k>if</span> <span class=nx>legacyscheme</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>.</span><span class=nf>IsVersionRegistered</span><span class=p>(</span><span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersion</span><span class=p>{</span><span class=nx>Group</span><span class=p>:</span> <span class=s>&#34;policy&#34;</span><span class=p>,</span> <span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1beta1&#34;</span><span class=p>})</span> <span class=p>{</span>
	<span class=nx>restStorageMap</span><span class=p>[</span><span class=s>&#34;pods/eviction&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>podStorage</span><span class=p>.</span><span class=nx>Eviction</span>
<span class=p>}</span>
<span class=k>if</span> <span class=nx>serviceAccountStorage</span><span class=p>.</span><span class=nx>Token</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
	<span class=nx>restStorageMap</span><span class=p>[</span><span class=s>&#34;serviceaccounts/token&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>serviceAccountStorage</span><span class=p>.</span><span class=nx>Token</span>
<span class=p>}</span>
<span class=k>if</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>EphemeralContainers</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>restStorageMap</span><span class=p>[</span><span class=s>&#34;pods/ephemeralcontainers&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>podStorage</span><span class=p>.</span><span class=nx>EphemeralContainers</span>
<span class=p>}</span>
<span class=nx>apiGroupInfo</span><span class=p>.</span><span class=nx>VersionedResourcesStorageMap</span><span class=p>[</span><span class=s>&#34;v1&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>restStorageMap</span>
</code></pre></div><p>最终完成以api开头的所有资源的RESTStorage操作。
创建完之后，则开始进行路由的安装，执行<code>InstallLegacyAPIGroup</code>方法，主要调用链为<code>InstallLegacyAPIGroup-->installAPIResources-->InstallREST-->Install-->registerResourceHandlers</code>，最终核心的路由构造在<code>registerResourceHandlers</code>方法内。这是一个非常复杂的方法，整个方法的代码在700行左右。方法的主要功能是通过上一步骤构造的RESTStorage判断该资源可以执行哪些操作（如create、update等），将其对应的操作存入到action，每一个action对应一个标准的rest操作，如create对应的action操作为POST、update对应的action操作为PUT。最终根据actions数组依次遍历，对每一个操作添加一个handler方法，注册到route中去，route注册到webservice中去，完美匹配go-restful的设计模式。</p>
<h4 id=路由添加apis开头>路由添加(apis开头)</h4>
<p>api开头的路由主要是对基础资源的路由实现，而对于其他附加的资源，如认证相关、网络相关等各种扩展的api资源，统一以apis开头命名，实现入口为<code>InstallAPIs</code>。
<code>InstallAPIs</code>与<code>InstallLegacyAPIGroup</code>主要的区别是获取RESTStorage的方式。对于api开头的路由来说，都是/api/v1这种统一的格式；而对于apis开头路由则不一样，它包含了多种不同的格式（Kubernetes代码内叫groupName），如/apis/apps、/apis/certificates.k8s.io等各种无规律的groupName。为此，kubernetes提供了一种<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L515>RESTStorageProvider</a>的工厂模式的接口</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// RESTStorageProvider is a factory type for REST storage.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>RESTStorageProvider</span> <span class=kd>interface</span> <span class=p>{</span>
	<span class=nf>GroupName</span><span class=p>()</span> <span class=kt>string</span>
	<span class=nf>NewRESTStorage</span><span class=p>(</span><span class=nx>apiResourceConfigSource</span> <span class=nx>serverstorage</span><span class=p>.</span><span class=nx>APIResourceConfigSource</span><span class=p>,</span> <span class=nx>restOptionsGetter</span> <span class=nx>generic</span><span class=p>.</span><span class=nx>RESTOptionsGetter</span><span class=p>)</span> <span class=p>(</span><span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>,</span> <span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>所有以apis开头的路由的资源都需要实现该接口。GroupName()方法获取到的就是类似于/apis/apps、/apis/certificates.k8s.io这样的groupName，NewRESTStorage方法获取到的是相对应的RESTStorage封装后的信息。</p>
<p>后续的操作和之前的步骤类似，通过构造go-restful格式的路由信息，完成创建，此处不做赘述。</p>
<h3 id=server端启动>Server端启动</h3>
<p>通过<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L164>CreateServerChain</a>创建完server后，继续调用<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go#L87>GenericAPIServer</a>的<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go#L316>Run</a>方法完成最终的启动工作。首先通过<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go#L283>PrepareRun</a>方法完成启动前的路由收尾工作，该方法主要完成了<code>Swagger</code>和<code>OpenAPI</code>路由的注册工作（<code>Swagger</code>和<code>OpenAPI</code>主要包含了Kubernetes API的所有细节与规范），并完成/healthz路由的注册工作。完成后，开始最终的server启动工作。
<code>Run</code>方法里通过<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go#L357>NonBlockingRun</a>方法启动安全的http server（非安全方式的启动在<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L164>CreateServerChain</a>方法已经完成）</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Run spawns the secure http server. It only returns if stopCh is closed
</span><span class=c1>// or the secure port cannot be listened on initially.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>preparedGenericAPIServer</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
	<span class=nx>delayedStopCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>

	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
		<span class=k>defer</span> <span class=nb>close</span><span class=p>(</span><span class=nx>delayedStopCh</span><span class=p>)</span>
		<span class=o>&lt;-</span><span class=nx>stopCh</span>

		<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>ShutdownDelayDuration</span><span class=p>)</span>
	<span class=p>}()</span>

	<span class=c1>// close socket after delayed stopCh
</span><span class=c1></span>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>NonBlockingRun</span><span class=p>(</span><span class=nx>delayedStopCh</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=o>&lt;-</span><span class=nx>stopCh</span>

	<span class=c1>// run shutdown hooks directly. This includes deregistering from the kubernetes endpoint in case of kube-apiserver.
</span><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>RunPreShutdownHooks</span><span class=p>()</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=c1>// wait for the delayed stopCh before closing the handler chain (it rejects everything after Wait has been called).
</span><span class=c1></span>	<span class=o>&lt;-</span><span class=nx>delayedStopCh</span>

	<span class=c1>// Wait for all requests to finish, which are bounded by the RequestTimeout variable.
</span><span class=c1></span>	<span class=nx>s</span><span class=p>.</span><span class=nx>HandlerChainWaitGroup</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>

	<span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>启动主要工作包括配置各种证书认证、时间参数、报文大小参数之类，之后通过调用net/http库的启动方式启动，代码比较简洁，不一一列出了。</p>
<h3 id=权限相关>权限相关</h3>
<p>ApiServer中与权限相关的主要有三种机制，即常用的认证、鉴权和准入控制。对apiserver来说，主要提供的就是rest风格的接口，所以各种权限最终还是集中到对接口的权限判断上。
以最核心的<code>kubeAPIServerConfig</code>(是一个<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L203>Config</a>实例)举例，在<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L164>CreateServerChain</a>方法中，调用了<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L268>CreateKubeAPIServerConfig</a>的方法，该方法主要的作用是创建kubeAPIServer的配置。进入该方法，调用了<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L412>buildGenericConfig</a>创建一些通用的配置，在<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L288>NewConfig</a>生成一个<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L84>Config</a>实例，其中的<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L140><code>BuildHandlerChainFunc</code></a>属性的值为<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L664>DefaultBuildHandlerChain</a>，该方法主要就是用来对apiserver rest接口的链式判断，即俗称的filter操作，先记录下，后续分析。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>DefaultBuildHandlerChain</span><span class=p>(</span><span class=nx>apiHandler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>,</span> <span class=nx>c</span> <span class=o>*</span><span class=nx>Config</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
	<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>genericapifilters</span><span class=p>.</span><span class=nf>WithAuthorization</span><span class=p>(</span><span class=nx>apiHandler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Authorization</span><span class=p>.</span><span class=nx>Authorizer</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Serializer</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>FlowControl</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericfilters</span><span class=p>.</span><span class=nf>WithPriorityAndFairness</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>LongRunningFunc</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>FlowControl</span><span class=p>)</span>
	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericfilters</span><span class=p>.</span><span class=nf>WithMaxInFlightLimit</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>MaxRequestsInFlight</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>MaxMutatingRequestsInFlight</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>LongRunningFunc</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericapifilters</span><span class=p>.</span><span class=nf>WithImpersonation</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Authorization</span><span class=p>.</span><span class=nx>Authorizer</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Serializer</span><span class=p>)</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericapifilters</span><span class=p>.</span><span class=nf>WithAudit</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>AuditBackend</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>AuditPolicyChecker</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>LongRunningFunc</span><span class=p>)</span>
	<span class=nx>failedHandler</span> <span class=o>:=</span> <span class=nx>genericapifilters</span><span class=p>.</span><span class=nf>Unauthorized</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Serializer</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>SupportsBasicAuth</span><span class=p>)</span>
	<span class=nx>failedHandler</span> <span class=p>=</span> <span class=nx>genericapifilters</span><span class=p>.</span><span class=nf>WithFailedAuthenticationAudit</span><span class=p>(</span><span class=nx>failedHandler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>AuditBackend</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>AuditPolicyChecker</span><span class=p>)</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericapifilters</span><span class=p>.</span><span class=nf>WithAuthentication</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>Authenticator</span><span class=p>,</span> <span class=nx>failedHandler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>APIAudiences</span><span class=p>)</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericfilters</span><span class=p>.</span><span class=nf>WithCORS</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>CorsAllowedOriginList</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;true&#34;</span><span class=p>)</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericfilters</span><span class=p>.</span><span class=nf>WithTimeoutForNonLongRunningRequests</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>LongRunningFunc</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>RequestTimeout</span><span class=p>)</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericfilters</span><span class=p>.</span><span class=nf>WithWaitGroup</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>LongRunningFunc</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>HandlerChainWaitGroup</span><span class=p>)</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericapifilters</span><span class=p>.</span><span class=nf>WithRequestInfo</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>RequestInfoResolver</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>SecureServing</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>c</span><span class=p>.</span><span class=nx>SecureServing</span><span class=p>.</span><span class=nx>DisableHTTP2</span> <span class=o>&amp;&amp;</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GoawayChance</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericfilters</span><span class=p>.</span><span class=nf>WithProbabilisticGoaway</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>GoawayChance</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericapifilters</span><span class=p>.</span><span class=nf>WithCacheControl</span><span class=p>(</span><span class=nx>handler</span><span class=p>)</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>genericfilters</span><span class=p>.</span><span class=nf>WithPanicRecovery</span><span class=p>(</span><span class=nx>handler</span><span class=p>)</span>
	<span class=k>return</span> <span class=nx>handler</span>
<span class=p>}</span>
</code></pre></div><p>配置文件创建完成后，再进行创建工作，进入到<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/cmd/kube-apiserver/app/server.go#L213>CreateKubeAPIServer</a>方法，然后一路跟踪下去(<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L203>kubeAPIServerConfig</a>&ndash;<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L286>Complete</a>&ndash;><a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L214>CompletedConfig</a>&ndash;<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/master/master.go#L336>New</a>&ndash;><a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L523>New</a>)，会在初始化go-restful的Container的方法内，可以看到</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>handlerChainBuilder</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>handler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nf>BuildHandlerChainFunc</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Config</span><span class=p>)</span>
<span class=p>}</span>
<span class=nx>apiServerHandler</span> <span class=o>:=</span> <span class=nf>NewAPIServerHandler</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Serializer</span><span class=p>,</span> <span class=nx>handlerChainBuilder</span><span class=p>,</span> <span class=nx>delegationTarget</span><span class=p>.</span><span class=nf>UnprotectedHandler</span><span class=p>())</span>
</code></pre></div><p><code>handlerChainBuilder</code>方法就是对返回的<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L664>DefaultBuildHandlerChain</a>方法的一种封装，并作为参数传入到<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/handler.go#L73>NewAPIServerHandler</a>方法内。进入<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/handler.go#L73>NewAPIServerHandler</a>方法，如下：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>NewAPIServerHandler</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>s</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>NegotiatedSerializer</span><span class=p>,</span> <span class=nx>handlerChainBuilder</span> <span class=nx>HandlerChainBuilderFn</span><span class=p>,</span> <span class=nx>notFoundHandler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=o>*</span><span class=nx>APIServerHandler</span> <span class=p>{</span>
	<span class=nx>nonGoRestfulMux</span> <span class=o>:=</span> <span class=nx>mux</span><span class=p>.</span><span class=nf>NewPathRecorderMux</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>notFoundHandler</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>nonGoRestfulMux</span><span class=p>.</span><span class=nf>NotFoundHandler</span><span class=p>(</span><span class=nx>notFoundHandler</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>gorestfulContainer</span> <span class=o>:=</span> <span class=nx>restful</span><span class=p>.</span><span class=nf>NewContainer</span><span class=p>()</span>
	<span class=nx>gorestfulContainer</span><span class=p>.</span><span class=nx>ServeMux</span> <span class=p>=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewServeMux</span><span class=p>()</span>
	<span class=nx>gorestfulContainer</span><span class=p>.</span><span class=nf>Router</span><span class=p>(</span><span class=nx>restful</span><span class=p>.</span><span class=nx>CurlyRouter</span><span class=p>{})</span> <span class=c1>// e.g. for proxy/{kind}/{name}/{*}
</span><span class=c1></span>	<span class=nx>gorestfulContainer</span><span class=p>.</span><span class=nf>RecoverHandler</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>panicReason</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>httpWriter</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>)</span> <span class=p>{</span>
		<span class=nf>logStackOnRecover</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>panicReason</span><span class=p>,</span> <span class=nx>httpWriter</span><span class=p>)</span>
	<span class=p>})</span>
	<span class=nx>gorestfulContainer</span><span class=p>.</span><span class=nf>ServiceErrorHandler</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>serviceErr</span> <span class=nx>restful</span><span class=p>.</span><span class=nx>ServiceError</span><span class=p>,</span> <span class=nx>request</span> <span class=o>*</span><span class=nx>restful</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>response</span> <span class=o>*</span><span class=nx>restful</span><span class=p>.</span><span class=nx>Response</span><span class=p>)</span> <span class=p>{</span>
		<span class=nf>serviceErrorHandler</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>serviceErr</span><span class=p>,</span> <span class=nx>request</span><span class=p>,</span> <span class=nx>response</span><span class=p>)</span>
	<span class=p>})</span>

	<span class=nx>director</span> <span class=o>:=</span> <span class=nx>director</span><span class=p>{</span>
		<span class=nx>name</span><span class=p>:</span>               <span class=nx>name</span><span class=p>,</span>
		<span class=nx>goRestfulContainer</span><span class=p>:</span> <span class=nx>gorestfulContainer</span><span class=p>,</span>
		<span class=nx>nonGoRestfulMux</span><span class=p>:</span>    <span class=nx>nonGoRestfulMux</span><span class=p>,</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>APIServerHandler</span><span class=p>{</span>
		<span class=nx>FullHandlerChain</span><span class=p>:</span>   <span class=nf>handlerChainBuilder</span><span class=p>(</span><span class=nx>director</span><span class=p>),</span>
		<span class=nx>GoRestfulContainer</span><span class=p>:</span> <span class=nx>gorestfulContainer</span><span class=p>,</span>
		<span class=nx>NonGoRestfulMux</span><span class=p>:</span>    <span class=nx>nonGoRestfulMux</span><span class=p>,</span>
		<span class=nx>Director</span><span class=p>:</span>           <span class=nx>director</span><span class=p>,</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>配置中通过将<code>director</code>作为参数传到<code>handlerChainBuilder</code>的回调方法内，完成对gorestfulContainer的handler的注册工作。其实director就是一个实现了http.Handler的变量。所以，整个的处理逻辑就是将类型为http.Handler的director作为参数，传递到链式<code>filter</code>的<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L664>DefaultBuildHandlerChain</a>方法内。通过<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L664>DefaultBuildHandlerChain</a>对每一个步骤的<code>filter</code>操作，完成权限控制等之类的操作。后续就是做启动工作，包括证书验证、TLS认证之类的工作，不做过多赘述。主要看下<code>filter</code>的<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L664>DefaultBuildHandlerChain</a>方法是如何处理接口的鉴权操作。</p>
<h3 id=rbac启动>RBAC启动</h3>
<p>Kubernetes中比较重要的用的比较多的可能就是RBAC了。在<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/server/config.go#L664>DefaultBuildHandlerChain</a>方法内，通过调用<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authorization.go#L45>genericapifilters.WithAuthorization</a>方法，实现对每个接口的权限的<code>filter</code>操作。<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authorization.go#L45>WithAuthorization</a>方法如下:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// WithAuthorizationCheck passes all authorized requests on to handler, and returns a forbidden error otherwise.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>WithAuthorization</span><span class=p>(</span><span class=nx>handler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>,</span> <span class=nx>a</span> <span class=nx>authorizer</span><span class=p>.</span><span class=nx>Authorizer</span><span class=p>,</span> <span class=nx>s</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>NegotiatedSerializer</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
	<span class=k>if</span> <span class=nx>a</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>klog</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;Authorization is disabled&#34;</span><span class=p>)</span>
		<span class=k>return</span> <span class=nx>handler</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nf>HandlerFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
		<span class=nx>ae</span> <span class=o>:=</span> <span class=nx>request</span><span class=p>.</span><span class=nf>AuditEventFrom</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>

		<span class=nx>attributes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>GetAuthorizerAttributes</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=nx>responsewriters</span><span class=p>.</span><span class=nf>InternalError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
			<span class=k>return</span>
		<span class=p>}</span>
		<span class=nx>authorized</span><span class=p>,</span> <span class=nx>reason</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>Authorize</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>attributes</span><span class=p>)</span>
		<span class=c1>// an authorizer like RBAC could encounter evaluation errors and still allow the request, so authorizer decision is checked before error here.
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>authorized</span> <span class=o>==</span> <span class=nx>authorizer</span><span class=p>.</span><span class=nx>DecisionAllow</span> <span class=p>{</span>
			<span class=nx>audit</span><span class=p>.</span><span class=nf>LogAnnotation</span><span class=p>(</span><span class=nx>ae</span><span class=p>,</span> <span class=nx>decisionAnnotationKey</span><span class=p>,</span> <span class=nx>decisionAllow</span><span class=p>)</span>
			<span class=nx>audit</span><span class=p>.</span><span class=nf>LogAnnotation</span><span class=p>(</span><span class=nx>ae</span><span class=p>,</span> <span class=nx>reasonAnnotationKey</span><span class=p>,</span> <span class=nx>reason</span><span class=p>)</span>
			<span class=nx>handler</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
			<span class=k>return</span>
		<span class=p>}</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=nx>audit</span><span class=p>.</span><span class=nf>LogAnnotation</span><span class=p>(</span><span class=nx>ae</span><span class=p>,</span> <span class=nx>reasonAnnotationKey</span><span class=p>,</span> <span class=nx>reasonError</span><span class=p>)</span>
			<span class=nx>responsewriters</span><span class=p>.</span><span class=nf>InternalError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
			<span class=k>return</span>
		<span class=p>}</span>

		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Forbidden: %#v, Reason: %q&#34;</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>RequestURI</span><span class=p>,</span> <span class=nx>reason</span><span class=p>)</span>
		<span class=nx>audit</span><span class=p>.</span><span class=nf>LogAnnotation</span><span class=p>(</span><span class=nx>ae</span><span class=p>,</span> <span class=nx>decisionAnnotationKey</span><span class=p>,</span> <span class=nx>decisionForbid</span><span class=p>)</span>
		<span class=nx>audit</span><span class=p>.</span><span class=nf>LogAnnotation</span><span class=p>(</span><span class=nx>ae</span><span class=p>,</span> <span class=nx>reasonAnnotationKey</span><span class=p>,</span> <span class=nx>reason</span><span class=p>)</span>
		<span class=nx>responsewriters</span><span class=p>.</span><span class=nf>Forbidden</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>attributes</span><span class=p>,</span> <span class=nx>w</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>reason</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
	<span class=p>})</span>
<span class=p>}</span>
</code></pre></div><ol>
<li>调用<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/endpoints/filters/authorization.go#L80>GetAuthorizerAttributes</a>方法获取配置的各种属性值；</li>
<li>调用<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/authorization/authorizer/interfaces.go#L71>Authorize</a>方法判断权限是否通过，不同的权限实现其接口，完成鉴权任务;</li>
<li>如果鉴权成功通过，则调用<code>handler.ServeHTTP</code>方法继续下一步的<code>filter</code>操作；否则，直接返回错误信息。
以RBAC为例，<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/plugin/pkg/auth/authorizer/rbac/rbac.go#L75>Authorize</a>方法最终调用<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/registry/rbac/validation/rule.go#L178>VisitRulesFor</a>方法实现权限的判断，VisitRulesFor主要代码如下:</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>DefaultRuleResolver</span><span class=p>)</span> <span class=nf>VisitRulesFor</span><span class=p>(</span><span class=nx>user</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Info</span><span class=p>,</span> <span class=nx>namespace</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>visitor</span> <span class=kd>func</span><span class=p>(</span><span class=nx>source</span> <span class=nx>fmt</span><span class=p>.</span><span class=nx>Stringer</span><span class=p>,</span> <span class=nx>rule</span> <span class=o>*</span><span class=nx>rbacv1</span><span class=p>.</span><span class=nx>PolicyRule</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>if</span> <span class=nx>clusterRoleBindings</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>clusterRoleBindingLister</span><span class=p>.</span><span class=nf>ListClusterRoleBindings</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>if</span> <span class=p>!</span><span class=nf>visitor</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
			<span class=k>return</span>
		<span class=p>}</span>
	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=nx>sourceDescriber</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>clusterRoleBindingDescriber</span><span class=p>{}</span>
		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>clusterRoleBinding</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>clusterRoleBindings</span> <span class=p>{</span>
			<span class=nx>subjectIndex</span><span class=p>,</span> <span class=nx>applies</span> <span class=o>:=</span> <span class=nf>appliesTo</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>clusterRoleBinding</span><span class=p>.</span><span class=nx>Subjects</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
			<span class=k>if</span> <span class=p>!</span><span class=nx>applies</span> <span class=p>{</span>
				<span class=k>continue</span>
			<span class=p>}</span>
			<span class=nx>rules</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>GetRoleReferenceRules</span><span class=p>(</span><span class=nx>clusterRoleBinding</span><span class=p>.</span><span class=nx>RoleRef</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
				<span class=k>if</span> <span class=p>!</span><span class=nf>visitor</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
					<span class=k>return</span>
				<span class=p>}</span>
				<span class=k>continue</span>
			<span class=p>}</span>
			<span class=nx>sourceDescriber</span><span class=p>.</span><span class=nx>binding</span> <span class=p>=</span> <span class=nx>clusterRoleBinding</span>
			<span class=nx>sourceDescriber</span><span class=p>.</span><span class=nx>subject</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>clusterRoleBinding</span><span class=p>.</span><span class=nx>Subjects</span><span class=p>[</span><span class=nx>subjectIndex</span><span class=p>]</span>
			<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rules</span> <span class=p>{</span>
				<span class=k>if</span> <span class=p>!</span><span class=nf>visitor</span><span class=p>(</span><span class=nx>sourceDescriber</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>rules</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=kc>nil</span><span class=p>)</span> <span class=p>{</span>
					<span class=k>return</span>
				<span class=p>}</span>
			<span class=p>}</span>
		<span class=p>}</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>namespace</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>roleBindings</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>roleBindingLister</span><span class=p>.</span><span class=nf>ListRoleBindings</span><span class=p>(</span><span class=nx>namespace</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>if</span> <span class=p>!</span><span class=nf>visitor</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
				<span class=k>return</span>
			<span class=p>}</span>
		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
			<span class=nx>sourceDescriber</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>roleBindingDescriber</span><span class=p>{}</span>
			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>roleBinding</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>roleBindings</span> <span class=p>{</span>
				<span class=nx>subjectIndex</span><span class=p>,</span> <span class=nx>applies</span> <span class=o>:=</span> <span class=nf>appliesTo</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>roleBinding</span><span class=p>.</span><span class=nx>Subjects</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>)</span>
				<span class=k>if</span> <span class=p>!</span><span class=nx>applies</span> <span class=p>{</span>
					<span class=k>continue</span>
				<span class=p>}</span>
				<span class=nx>rules</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>GetRoleReferenceRules</span><span class=p>(</span><span class=nx>roleBinding</span><span class=p>.</span><span class=nx>RoleRef</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>)</span>
				<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
					<span class=k>if</span> <span class=p>!</span><span class=nf>visitor</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
						<span class=k>return</span>
					<span class=p>}</span>
					<span class=k>continue</span>
				<span class=p>}</span>
				<span class=nx>sourceDescriber</span><span class=p>.</span><span class=nx>binding</span> <span class=p>=</span> <span class=nx>roleBinding</span>
				<span class=nx>sourceDescriber</span><span class=p>.</span><span class=nx>subject</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>roleBinding</span><span class=p>.</span><span class=nx>Subjects</span><span class=p>[</span><span class=nx>subjectIndex</span><span class=p>]</span>
				<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rules</span> <span class=p>{</span>
					<span class=k>if</span> <span class=p>!</span><span class=nf>visitor</span><span class=p>(</span><span class=nx>sourceDescriber</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>rules</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=kc>nil</span><span class=p>)</span> <span class=p>{</span>
						<span class=k>return</span>
					<span class=p>}</span>
				<span class=p>}</span>
			<span class=p>}</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>主要工作就是对<code>clusterRoleBinding</code>以及<code>roleBinding</code>与配置的资源进行判断，比较清晰明了，这与我们使用RBAC的思路基本一致。</p>
<h3 id=数据库操作>数据库操作</h3>
<p>ApiServer与数据库的交互主要指的是与etcd的交互。Kubernetes所有的组件不直接与etcd交互，都是通过请求apiserver，apiserver与etcd进行交互完成数据的最终落盘。
在之前的路由实现已经说过，apiserver最终实现的handler对应的后端数据是以<code>Store</code>的结构保存的。这里以api开头的路由举例，在<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/pkg/registry/core/rest/storage_core.go#L102>NewLegacyRESTStorage</a>方法中，通过<code>NewREST</code>或者<code>NewStorage</code>会生成各种资源对应的Storage，以<code>endpoints</code>为例，生成的方法如下:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// NewREST returns a RESTStorage object that will work against endpoints.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>NewREST</span><span class=p>(</span><span class=nx>optsGetter</span> <span class=nx>generic</span><span class=p>.</span><span class=nx>RESTOptionsGetter</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>REST</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>store</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>genericregistry</span><span class=p>.</span><span class=nx>Store</span><span class=p>{</span>
		<span class=nx>NewFunc</span><span class=p>:</span>                  <span class=kd>func</span><span class=p>()</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span> <span class=p>{</span> <span class=k>return</span> <span class=o>&amp;</span><span class=nx>api</span><span class=p>.</span><span class=nx>Endpoints</span><span class=p>{}</span> <span class=p>},</span>
		<span class=nx>NewListFunc</span><span class=p>:</span>              <span class=kd>func</span><span class=p>()</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span> <span class=p>{</span> <span class=k>return</span> <span class=o>&amp;</span><span class=nx>api</span><span class=p>.</span><span class=nx>EndpointsList</span><span class=p>{}</span> <span class=p>},</span>
		<span class=nx>DefaultQualifiedResource</span><span class=p>:</span> <span class=nx>api</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=s>&#34;endpoints&#34;</span><span class=p>),</span>

		<span class=nx>CreateStrategy</span><span class=p>:</span> <span class=nx>endpoint</span><span class=p>.</span><span class=nx>Strategy</span><span class=p>,</span>
		<span class=nx>UpdateStrategy</span><span class=p>:</span> <span class=nx>endpoint</span><span class=p>.</span><span class=nx>Strategy</span><span class=p>,</span>
		<span class=nx>DeleteStrategy</span><span class=p>:</span> <span class=nx>endpoint</span><span class=p>.</span><span class=nx>Strategy</span><span class=p>,</span>

		<span class=nx>TableConvertor</span><span class=p>:</span> <span class=nx>printerstorage</span><span class=p>.</span><span class=nx>TableConvertor</span><span class=p>{</span><span class=nx>TableGenerator</span><span class=p>:</span> <span class=nx>printers</span><span class=p>.</span><span class=nf>NewTableGenerator</span><span class=p>().</span><span class=nf>With</span><span class=p>(</span><span class=nx>printersinternal</span><span class=p>.</span><span class=nx>AddHandlers</span><span class=p>)},</span>
	<span class=p>}</span>
	<span class=nx>options</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>generic</span><span class=p>.</span><span class=nx>StoreOptions</span><span class=p>{</span><span class=nx>RESTOptions</span><span class=p>:</span> <span class=nx>optsGetter</span><span class=p>}</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>store</span><span class=p>.</span><span class=nf>CompleteWithOptions</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>REST</span><span class=p>{</span><span class=nx>store</span><span class=p>},</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>主要看<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L1206>CompleteWithOptions</a>方法，在<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L1206>CompleteWithOptions</a>方法内，调用了<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/options.go#L29>RESTOptions</a>的<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/options.go#L40>GetRESTOptions</a>方法，依次调用<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/storage_factory.go#L35>StorageWithCacher</a>&ndash;><a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/storage_decorator.go#L56>NewRawStorage</a>&ndash;><a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/storage/storagebackend/factory/factory.go#L30>Create</a>方法创建最终依赖的后端存储：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Create creates a storage backend based on given config.
</span><span class=c1></span><span class=kd>func</span> <span class=nf>Create</span><span class=p>(</span><span class=nx>c</span> <span class=nx>storagebackend</span><span class=p>.</span><span class=nx>Config</span><span class=p>)</span> <span class=p>(</span><span class=nx>storage</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>DestroyFunc</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>switch</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
	<span class=k>case</span> <span class=s>&#34;etcd2&#34;</span><span class=p>:</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%v is no longer a supported storage backend&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Type</span><span class=p>)</span>
	<span class=k>case</span> <span class=nx>storagebackend</span><span class=p>.</span><span class=nx>StorageTypeUnset</span><span class=p>,</span> <span class=nx>storagebackend</span><span class=p>.</span><span class=nx>StorageTypeETCD3</span><span class=p>:</span>
		<span class=k>return</span> <span class=nf>newETCD3Storage</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
	<span class=k>default</span><span class=p>:</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unknown storage type: %s&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Type</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>可以看到，通过<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/storage/storagebackend/factory/factory.go#L30>Create</a>方法判断是创建etcd2或是etcd3的后端etcd版本，目前版本默认的是etcd3。
创建完成对应的存储之后，接下来要做的工作就是将对应的handler方法和最终的后台存储实现绑定起来（handler方法处理最终的数据需要落盘）。
还记着之前说的有个比较长的方法<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/endpoints/installer.go#L181>registerResourceHandlers</a>，用来处理具体的handler路由。再次回到该方法，</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=o>...</span>
<span class=k>switch</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span> <span class=p>{</span>
<span class=k>case</span> <span class=s>&#34;GET&#34;</span><span class=p>:</span> <span class=c1>// Get a resource.
</span><span class=c1></span>	<span class=kd>var</span> <span class=nx>handler</span> <span class=nx>restful</span><span class=p>.</span><span class=nx>RouteFunction</span>
	<span class=k>if</span> <span class=nx>isGetterWithOptions</span> <span class=p>{</span>
		<span class=nx>handler</span> <span class=p>=</span> <span class=nf>restfulGetResourceWithOptions</span><span class=p>(</span><span class=nx>getterWithOptions</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=nx>isSubresource</span><span class=p>)</span>
	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=nx>handler</span> <span class=p>=</span> <span class=nf>restfulGetResource</span><span class=p>(</span><span class=nx>getter</span><span class=p>,</span> <span class=nx>exporter</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>needOverride</span> <span class=p>{</span>
		<span class=c1>// need change the reported verb
</span><span class=c1></span>		<span class=nx>handler</span> <span class=p>=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>verbOverrider</span><span class=p>.</span><span class=nf>OverrideMetricsVerb</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>),</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nx>handler</span><span class=p>)</span>
	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=nx>handler</span> <span class=p>=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nx>handler</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;read the specified &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
		<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;read &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of the specified &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=p>}</span>
	<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span><span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
		<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
		<span class=nf>Param</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nf>QueryParameter</span><span class=p>(</span><span class=s>&#34;pretty&#34;</span><span class=p>,</span> <span class=s>&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class=p>)).</span>
		<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;read&#34;</span><span class=o>+</span><span class=nx>namespaced</span><span class=o>+</span><span class=nx>kind</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span><span class=o>+</span><span class=nx>operationSuffix</span><span class=p>).</span>
		<span class=nf>Produces</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>storageMeta</span><span class=p>.</span><span class=nf>ProducesMIMETypes</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>),</span> <span class=nx>mediaTypes</span><span class=o>...</span><span class=p>)</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;OK&#34;</span><span class=p>,</span> <span class=nx>producedObject</span><span class=p>).</span>
		<span class=nf>Writes</span><span class=p>(</span><span class=nx>producedObject</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>isGetterWithOptions</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedGetOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
		<span class=p>}</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>isExporter</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedExportOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
		<span class=p>}</span>
	<span class=p>}</span>
	<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
	<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>
<span class=k>case</span> <span class=s>&#34;LIST&#34;</span><span class=p>:</span> <span class=c1>// List all resources of a kind.
</span><span class=c1></span>	<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;list objects of kind &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
		<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;list &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of objects of kind &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=p>}</span>
	<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nf>restfulListResource</span><span class=p>(</span><span class=nx>lister</span><span class=p>,</span> <span class=nx>watcher</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>a</span><span class=p>.</span><span class=nx>minRequestTimeout</span><span class=p>))</span>
	<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span><span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
		<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
		<span class=nf>Param</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nf>QueryParameter</span><span class=p>(</span><span class=s>&#34;pretty&#34;</span><span class=p>,</span> <span class=s>&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class=p>)).</span>
		<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;list&#34;</span><span class=o>+</span><span class=nx>namespaced</span><span class=o>+</span><span class=nx>kind</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span><span class=o>+</span><span class=nx>operationSuffix</span><span class=p>).</span>
		<span class=nf>Produces</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>storageMeta</span><span class=p>.</span><span class=nf>ProducesMIMETypes</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>),</span> <span class=nx>allMediaTypes</span><span class=o>...</span><span class=p>)</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;OK&#34;</span><span class=p>,</span> <span class=nx>versionedList</span><span class=p>).</span>
		<span class=nf>Writes</span><span class=p>(</span><span class=nx>versionedList</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedListOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>switch</span> <span class=p>{</span>
	<span class=k>case</span> <span class=nx>isLister</span> <span class=o>&amp;&amp;</span> <span class=nx>isWatcher</span><span class=p>:</span>
		<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;list or watch objects of kind &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
		<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
			<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;list or watch &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of objects of kind &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
		<span class=p>}</span>
		<span class=nx>route</span><span class=p>.</span><span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>)</span>
	<span class=k>case</span> <span class=nx>isWatcher</span><span class=p>:</span>
		<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;watch objects of kind &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
		<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
			<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;watch &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34;of objects of kind &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
		<span class=p>}</span>
		<span class=nx>route</span><span class=p>.</span><span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
	<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>
<span class=k>case</span> <span class=s>&#34;PUT&#34;</span><span class=p>:</span> <span class=c1>// Update a resource.
</span><span class=c1></span>	<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;replace the specified &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
		<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;replace &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of the specified &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=p>}</span>
	<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nf>restfulUpdateResource</span><span class=p>(</span><span class=nx>updater</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=nx>admit</span><span class=p>))</span>
	<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>PUT</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span><span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
		<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
		<span class=nf>Param</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nf>QueryParameter</span><span class=p>(</span><span class=s>&#34;pretty&#34;</span><span class=p>,</span> <span class=s>&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class=p>)).</span>
		<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;replace&#34;</span><span class=o>+</span><span class=nx>namespaced</span><span class=o>+</span><span class=nx>kind</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span><span class=o>+</span><span class=nx>operationSuffix</span><span class=p>).</span>
		<span class=nf>Produces</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>storageMeta</span><span class=p>.</span><span class=nf>ProducesMIMETypes</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>),</span> <span class=nx>mediaTypes</span><span class=o>...</span><span class=p>)</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;OK&#34;</span><span class=p>,</span> <span class=nx>producedObject</span><span class=p>).</span>
		<span class=c1>// TODO: in some cases, the API may return a v1.Status instead of the versioned object
</span><span class=c1></span>		<span class=c1>// but currently go-restful can&#39;t handle multiple different objects being returned.
</span><span class=c1></span>		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusCreated</span><span class=p>,</span> <span class=s>&#34;Created&#34;</span><span class=p>,</span> <span class=nx>producedObject</span><span class=p>).</span>
		<span class=nf>Reads</span><span class=p>(</span><span class=nx>defaultVersionedObject</span><span class=p>).</span>
		<span class=nf>Writes</span><span class=p>(</span><span class=nx>producedObject</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedUpdateOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
	<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>
<span class=k>case</span> <span class=s>&#34;PATCH&#34;</span><span class=p>:</span> <span class=c1>// Partially update a resource
</span><span class=c1></span>	<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;partially update the specified &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
		<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;partially update &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of the specified &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=p>}</span>
	<span class=nx>supportedTypes</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
		<span class=nb>string</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nx>JSONPatchType</span><span class=p>),</span>
		<span class=nb>string</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nx>MergePatchType</span><span class=p>),</span>
		<span class=nb>string</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nx>StrategicMergePatchType</span><span class=p>),</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>ServerSideApply</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>supportedTypes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>supportedTypes</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nx>ApplyPatchType</span><span class=p>))</span>
	<span class=p>}</span>
	<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nf>restfulPatchResource</span><span class=p>(</span><span class=nx>patcher</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=nx>admit</span><span class=p>,</span> <span class=nx>supportedTypes</span><span class=p>))</span>
	<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>PATCH</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span><span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
		<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
		<span class=nf>Param</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nf>QueryParameter</span><span class=p>(</span><span class=s>&#34;pretty&#34;</span><span class=p>,</span> <span class=s>&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class=p>)).</span>
		<span class=nf>Consumes</span><span class=p>(</span><span class=nx>supportedTypes</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;patch&#34;</span><span class=o>+</span><span class=nx>namespaced</span><span class=o>+</span><span class=nx>kind</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span><span class=o>+</span><span class=nx>operationSuffix</span><span class=p>).</span>
		<span class=nf>Produces</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>storageMeta</span><span class=p>.</span><span class=nf>ProducesMIMETypes</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>),</span> <span class=nx>mediaTypes</span><span class=o>...</span><span class=p>)</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;OK&#34;</span><span class=p>,</span> <span class=nx>producedObject</span><span class=p>).</span>
		<span class=nf>Reads</span><span class=p>(</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Patch</span><span class=p>{}).</span>
		<span class=nf>Writes</span><span class=p>(</span><span class=nx>producedObject</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedPatchOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
	<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>
<span class=k>case</span> <span class=s>&#34;POST&#34;</span><span class=p>:</span> <span class=c1>// Create a resource.
</span><span class=c1></span>	<span class=kd>var</span> <span class=nx>handler</span> <span class=nx>restful</span><span class=p>.</span><span class=nx>RouteFunction</span>
	<span class=k>if</span> <span class=nx>isNamedCreater</span> <span class=p>{</span>
		<span class=nx>handler</span> <span class=p>=</span> <span class=nf>restfulCreateNamedResource</span><span class=p>(</span><span class=nx>namedCreater</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=nx>admit</span><span class=p>)</span>
	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=nx>handler</span> <span class=p>=</span> <span class=nf>restfulCreateResource</span><span class=p>(</span><span class=nx>creater</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=nx>admit</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nx>handler</span><span class=p>)</span>
	<span class=nx>article</span> <span class=o>:=</span> <span class=nf>GetArticleForNoun</span><span class=p>(</span><span class=nx>kind</span><span class=p>,</span> <span class=s>&#34; &#34;</span><span class=p>)</span>
	<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;create&#34;</span> <span class=o>+</span> <span class=nx>article</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
		<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;create &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of&#34;</span> <span class=o>+</span> <span class=nx>article</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=p>}</span>
	<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span><span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
		<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
		<span class=nf>Param</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nf>QueryParameter</span><span class=p>(</span><span class=s>&#34;pretty&#34;</span><span class=p>,</span> <span class=s>&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class=p>)).</span>
		<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;create&#34;</span><span class=o>+</span><span class=nx>namespaced</span><span class=o>+</span><span class=nx>kind</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span><span class=o>+</span><span class=nx>operationSuffix</span><span class=p>).</span>
		<span class=nf>Produces</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>storageMeta</span><span class=p>.</span><span class=nf>ProducesMIMETypes</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>),</span> <span class=nx>mediaTypes</span><span class=o>...</span><span class=p>)</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;OK&#34;</span><span class=p>,</span> <span class=nx>producedObject</span><span class=p>).</span>
		<span class=c1>// TODO: in some cases, the API may return a v1.Status instead of the versioned object
</span><span class=c1></span>		<span class=c1>// but currently go-restful can&#39;t handle multiple different objects being returned.
</span><span class=c1></span>		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusCreated</span><span class=p>,</span> <span class=s>&#34;Created&#34;</span><span class=p>,</span> <span class=nx>producedObject</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusAccepted</span><span class=p>,</span> <span class=s>&#34;Accepted&#34;</span><span class=p>,</span> <span class=nx>producedObject</span><span class=p>).</span>
		<span class=nf>Reads</span><span class=p>(</span><span class=nx>defaultVersionedObject</span><span class=p>).</span>
		<span class=nf>Writes</span><span class=p>(</span><span class=nx>producedObject</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedCreateOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
	<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>
<span class=k>case</span> <span class=s>&#34;DELETE&#34;</span><span class=p>:</span> <span class=c1>// Delete a resource.
</span><span class=c1></span>	<span class=nx>article</span> <span class=o>:=</span> <span class=nf>GetArticleForNoun</span><span class=p>(</span><span class=nx>kind</span><span class=p>,</span> <span class=s>&#34; &#34;</span><span class=p>)</span>
	<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;delete&#34;</span> <span class=o>+</span> <span class=nx>article</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
		<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;delete &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of&#34;</span> <span class=o>+</span> <span class=nx>article</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=p>}</span>
	<span class=nx>deleteReturnType</span> <span class=o>:=</span> <span class=nx>versionedStatus</span>
	<span class=k>if</span> <span class=nx>deleteReturnsDeletedObject</span> <span class=p>{</span>
		<span class=nx>deleteReturnType</span> <span class=p>=</span> <span class=nx>producedObject</span>
	<span class=p>}</span>
	<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nf>restfulDeleteResource</span><span class=p>(</span><span class=nx>gracefulDeleter</span><span class=p>,</span> <span class=nx>isGracefulDeleter</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=nx>admit</span><span class=p>))</span>
	<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>DELETE</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span><span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
		<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
		<span class=nf>Param</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nf>QueryParameter</span><span class=p>(</span><span class=s>&#34;pretty&#34;</span><span class=p>,</span> <span class=s>&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class=p>)).</span>
		<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;delete&#34;</span><span class=o>+</span><span class=nx>namespaced</span><span class=o>+</span><span class=nx>kind</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span><span class=o>+</span><span class=nx>operationSuffix</span><span class=p>).</span>
		<span class=nf>Produces</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>storageMeta</span><span class=p>.</span><span class=nf>ProducesMIMETypes</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>),</span> <span class=nx>mediaTypes</span><span class=o>...</span><span class=p>)</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Writes</span><span class=p>(</span><span class=nx>deleteReturnType</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;OK&#34;</span><span class=p>,</span> <span class=nx>deleteReturnType</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusAccepted</span><span class=p>,</span> <span class=s>&#34;Accepted&#34;</span><span class=p>,</span> <span class=nx>deleteReturnType</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>isGracefulDeleter</span> <span class=p>{</span>
		<span class=nx>route</span><span class=p>.</span><span class=nf>Reads</span><span class=p>(</span><span class=nx>versionedDeleterObject</span><span class=p>)</span>
		<span class=nx>route</span><span class=p>.</span><span class=nf>ParameterNamed</span><span class=p>(</span><span class=s>&#34;body&#34;</span><span class=p>).</span><span class=nf>Required</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedDeleteOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
		<span class=p>}</span>
	<span class=p>}</span>
	<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
	<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>
<span class=k>case</span> <span class=s>&#34;DELETECOLLECTION&#34;</span><span class=p>:</span>
	<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;delete collection of &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
		<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;delete collection of &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of a &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=p>}</span>
	<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nf>restfulDeleteCollection</span><span class=p>(</span><span class=nx>collectionDeleter</span><span class=p>,</span> <span class=nx>isCollectionDeleter</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=nx>admit</span><span class=p>))</span>
	<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>DELETE</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span><span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
		<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
		<span class=nf>Param</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nf>QueryParameter</span><span class=p>(</span><span class=s>&#34;pretty&#34;</span><span class=p>,</span> <span class=s>&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class=p>)).</span>
		<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;deletecollection&#34;</span><span class=o>+</span><span class=nx>namespaced</span><span class=o>+</span><span class=nx>kind</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span><span class=o>+</span><span class=nx>operationSuffix</span><span class=p>).</span>
		<span class=nf>Produces</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>storageMeta</span><span class=p>.</span><span class=nf>ProducesMIMETypes</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>),</span> <span class=nx>mediaTypes</span><span class=o>...</span><span class=p>)</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Writes</span><span class=p>(</span><span class=nx>versionedStatus</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;OK&#34;</span><span class=p>,</span> <span class=nx>versionedStatus</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>isCollectionDeleter</span> <span class=p>{</span>
		<span class=nx>route</span><span class=p>.</span><span class=nf>Reads</span><span class=p>(</span><span class=nx>versionedDeleterObject</span><span class=p>)</span>
		<span class=nx>route</span><span class=p>.</span><span class=nf>ParameterNamed</span><span class=p>(</span><span class=s>&#34;body&#34;</span><span class=p>).</span><span class=nf>Required</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedDeleteOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
		<span class=p>}</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedListOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
	<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>
<span class=c1>// deprecated in 1.11
</span><span class=c1></span><span class=k>case</span> <span class=s>&#34;WATCH&#34;</span><span class=p>:</span> <span class=c1>// Watch a resource.
</span><span class=c1></span>	<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;watch changes to an object of kind &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
		<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;watch changes to &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of an object of kind &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=p>}</span>
	<span class=nx>doc</span> <span class=o>+=</span> <span class=s>&#34;. deprecated: use the &#39;watch&#39; parameter with a list operation instead, filtered to a single item with the &#39;fieldSelector&#39; parameter.&#34;</span>
	<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nf>restfulListResource</span><span class=p>(</span><span class=nx>lister</span><span class=p>,</span> <span class=nx>watcher</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>a</span><span class=p>.</span><span class=nx>minRequestTimeout</span><span class=p>))</span>
	<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span><span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
		<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
		<span class=nf>Param</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nf>QueryParameter</span><span class=p>(</span><span class=s>&#34;pretty&#34;</span><span class=p>,</span> <span class=s>&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class=p>)).</span>
		<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;watch&#34;</span><span class=o>+</span><span class=nx>namespaced</span><span class=o>+</span><span class=nx>kind</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span><span class=o>+</span><span class=nx>operationSuffix</span><span class=p>).</span>
		<span class=nf>Produces</span><span class=p>(</span><span class=nx>allMediaTypes</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;OK&#34;</span><span class=p>,</span> <span class=nx>versionedWatchEvent</span><span class=p>).</span>
		<span class=nf>Writes</span><span class=p>(</span><span class=nx>versionedWatchEvent</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedListOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
	<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>
<span class=c1>// deprecated in 1.11
</span><span class=c1></span><span class=k>case</span> <span class=s>&#34;WATCHLIST&#34;</span><span class=p>:</span> <span class=c1>// Watch all resources of a kind.
</span><span class=c1></span>	<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;watch individual changes to a list of &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
		<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;watch individual changes to a list of &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=p>}</span>
	<span class=nx>doc</span> <span class=o>+=</span> <span class=s>&#34;. deprecated: use the &#39;watch&#39; parameter with a list operation instead.&#34;</span>
	<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nf>restfulListResource</span><span class=p>(</span><span class=nx>lister</span><span class=p>,</span> <span class=nx>watcher</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>a</span><span class=p>.</span><span class=nx>minRequestTimeout</span><span class=p>))</span>
	<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span><span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
		<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
		<span class=nf>Param</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nf>QueryParameter</span><span class=p>(</span><span class=s>&#34;pretty&#34;</span><span class=p>,</span> <span class=s>&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class=p>)).</span>
		<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;watch&#34;</span><span class=o>+</span><span class=nx>namespaced</span><span class=o>+</span><span class=nx>kind</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span><span class=o>+</span><span class=s>&#34;List&#34;</span><span class=o>+</span><span class=nx>operationSuffix</span><span class=p>).</span>
		<span class=nf>Produces</span><span class=p>(</span><span class=nx>allMediaTypes</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;OK&#34;</span><span class=p>,</span> <span class=nx>versionedWatchEvent</span><span class=p>).</span>
		<span class=nf>Writes</span><span class=p>(</span><span class=nx>versionedWatchEvent</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedListOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
	<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>
<span class=k>case</span> <span class=s>&#34;CONNECT&#34;</span><span class=p>:</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>method</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>connecter</span><span class=p>.</span><span class=nf>ConnectMethods</span><span class=p>()</span> <span class=p>{</span>
		<span class=nx>connectProducedObject</span> <span class=o>:=</span> <span class=nx>storageMeta</span><span class=p>.</span><span class=nf>ProducesObject</span><span class=p>(</span><span class=nx>method</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>connectProducedObject</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=nx>connectProducedObject</span> <span class=p>=</span> <span class=s>&#34;string&#34;</span>
		<span class=p>}</span>
		<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;connect &#34;</span> <span class=o>+</span> <span class=nx>method</span> <span class=o>+</span> <span class=s>&#34; requests to &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
		<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
			<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;connect &#34;</span> <span class=o>+</span> <span class=nx>method</span> <span class=o>+</span> <span class=s>&#34; requests to &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of &#34;</span> <span class=o>+</span> <span class=nx>kind</span>
		<span class=p>}</span>
		<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nf>restfulConnectResource</span><span class=p>(</span><span class=nx>connecter</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=nx>admit</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>isSubresource</span><span class=p>))</span>
		<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>Method</span><span class=p>(</span><span class=nx>method</span><span class=p>).</span><span class=nf>Path</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span>
			<span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
			<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
			<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;connect&#34;</span> <span class=o>+</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>method</span><span class=p>))</span> <span class=o>+</span> <span class=nx>namespaced</span> <span class=o>+</span> <span class=nx>kind</span> <span class=o>+</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span> <span class=o>+</span> <span class=nx>operationSuffix</span><span class=p>).</span>
			<span class=nf>Produces</span><span class=p>(</span><span class=s>&#34;*/*&#34;</span><span class=p>).</span>
			<span class=nf>Consumes</span><span class=p>(</span><span class=s>&#34;*/*&#34;</span><span class=p>).</span>
			<span class=nf>Writes</span><span class=p>(</span><span class=nx>connectProducedObject</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>versionedConnectOptions</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedConnectOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
			<span class=p>}</span>
		<span class=p>}</span>
		<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
		<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>

		<span class=c1>// transform ConnectMethods to kube verbs
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>kubeVerb</span><span class=p>,</span> <span class=nx>found</span> <span class=o>:=</span> <span class=nx>toDiscoveryKubeVerb</span><span class=p>[</span><span class=nx>method</span><span class=p>];</span> <span class=nx>found</span> <span class=p>{</span>
			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>kubeVerb</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
				<span class=nx>kubeVerbs</span><span class=p>[</span><span class=nx>kubeVerb</span><span class=p>]</span> <span class=p>=</span> <span class=kd>struct</span><span class=p>{}{}</span>
			<span class=p>}</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=k>default</span><span class=p>:</span>
	<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unrecognized action verb: %s&#34;</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>)</span>
<span class=p>}</span>
<span class=o>...</span>
</code></pre></div><p>每个case语句代码一种请求类型和相对应的handler方法，以<code>POST</code>方法为例，对应的是Create操作。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=k>case</span> <span class=s>&#34;POST&#34;</span><span class=p>:</span> <span class=c1>// Create a resource.
</span><span class=c1></span>	<span class=kd>var</span> <span class=nx>handler</span> <span class=nx>restful</span><span class=p>.</span><span class=nx>RouteFunction</span>
	<span class=k>if</span> <span class=nx>isNamedCreater</span> <span class=p>{</span>
		<span class=nx>handler</span> <span class=p>=</span> <span class=nf>restfulCreateNamedResource</span><span class=p>(</span><span class=nx>namedCreater</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=nx>admit</span><span class=p>)</span>
	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
		<span class=nx>handler</span> <span class=p>=</span> <span class=nf>restfulCreateResource</span><span class=p>(</span><span class=nx>creater</span><span class=p>,</span> <span class=nx>reqScope</span><span class=p>,</span> <span class=nx>admit</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>handler</span> <span class=p>=</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>InstrumentRouteFunc</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span> <span class=nx>group</span><span class=p>,</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>subresource</span><span class=p>,</span> <span class=nx>requestScope</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>APIServerComponent</span><span class=p>,</span> <span class=nx>handler</span><span class=p>)</span>
	<span class=nx>article</span> <span class=o>:=</span> <span class=nf>GetArticleForNoun</span><span class=p>(</span><span class=nx>kind</span><span class=p>,</span> <span class=s>&#34; &#34;</span><span class=p>)</span>
	<span class=nx>doc</span> <span class=o>:=</span> <span class=s>&#34;create&#34;</span> <span class=o>+</span> <span class=nx>article</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=k>if</span> <span class=nx>isSubresource</span> <span class=p>{</span>
		<span class=nx>doc</span> <span class=p>=</span> <span class=s>&#34;create &#34;</span> <span class=o>+</span> <span class=nx>subresource</span> <span class=o>+</span> <span class=s>&#34; of&#34;</span> <span class=o>+</span> <span class=nx>article</span> <span class=o>+</span> <span class=nx>kind</span>
	<span class=p>}</span>
	<span class=nx>route</span> <span class=o>:=</span> <span class=nx>ws</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Path</span><span class=p>).</span><span class=nf>To</span><span class=p>(</span><span class=nx>handler</span><span class=p>).</span>
		<span class=nf>Doc</span><span class=p>(</span><span class=nx>doc</span><span class=p>).</span>
		<span class=nf>Param</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nf>QueryParameter</span><span class=p>(</span><span class=s>&#34;pretty&#34;</span><span class=p>,</span> <span class=s>&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class=p>)).</span>
		<span class=nf>Operation</span><span class=p>(</span><span class=s>&#34;create&#34;</span><span class=o>+</span><span class=nx>namespaced</span><span class=o>+</span><span class=nx>kind</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Title</span><span class=p>(</span><span class=nx>subresource</span><span class=p>)</span><span class=o>+</span><span class=nx>operationSuffix</span><span class=p>).</span>
		<span class=nf>Produces</span><span class=p>(</span><span class=nb>append</span><span class=p>(</span><span class=nx>storageMeta</span><span class=p>.</span><span class=nf>ProducesMIMETypes</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>Verb</span><span class=p>),</span> <span class=nx>mediaTypes</span><span class=o>...</span><span class=p>)</span><span class=o>...</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=s>&#34;OK&#34;</span><span class=p>,</span> <span class=nx>producedObject</span><span class=p>).</span>
		<span class=c1>// TODO: in some cases, the API may return a v1.Status instead of the versioned object
</span><span class=c1></span>		<span class=c1>// but currently go-restful can&#39;t handle multiple different objects being returned.
</span><span class=c1></span>		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusCreated</span><span class=p>,</span> <span class=s>&#34;Created&#34;</span><span class=p>,</span> <span class=nx>producedObject</span><span class=p>).</span>
		<span class=nf>Returns</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusAccepted</span><span class=p>,</span> <span class=s>&#34;Accepted&#34;</span><span class=p>,</span> <span class=nx>producedObject</span><span class=p>).</span>
		<span class=nf>Reads</span><span class=p>(</span><span class=nx>defaultVersionedObject</span><span class=p>).</span>
		<span class=nf>Writes</span><span class=p>(</span><span class=nx>producedObject</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>AddObjectParams</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>versionedCreateOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nf>addParams</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>action</span><span class=p>.</span><span class=nx>Params</span><span class=p>)</span>
	<span class=nx>routes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>route</span><span class=p>)</span>
</code></pre></div><p><code>handler</code>参数的调用最终都会走到<a href>createHandler</a>方法处，位于<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/endpoints/handlers/create.go#L145>k8s.io/apiserver/pkg/endpoints/handlers/crete.go</a>下。最核心的步骤即调用了Create方法：</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>requestFunc</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>()</span> <span class=p>(</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span>
		<span class=nx>ctx</span><span class=p>,</span>
		<span class=nx>name</span><span class=p>,</span>
		<span class=nx>obj</span><span class=p>,</span>
		<span class=nx>rest</span><span class=p>.</span><span class=nf>AdmissionToValidateObjectFunc</span><span class=p>(</span><span class=nx>admit</span><span class=p>,</span> <span class=nx>admissionAttributes</span><span class=p>,</span> <span class=nx>scope</span><span class=p>),</span>
		<span class=nx>options</span><span class=p>,</span>
	<span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>一步步走下去，最终调用的是位于<code>kubernetes/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go</code>下的<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L338>Create</a>方法。该方法主要包含<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/rest/create.go#L74>BeforeCreate</a>、<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/dryrun.go#L36>Storage.Create</a>、<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L153>AfterCreate</a>以及<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L148>Decorator</a>等主要方法。对应于<code>POST</code>操作，则最主要的方法为<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/storage/etcd3/store.go#L144>Storage.Create</a>。由于目前使用基本都是etcd3，所以实现的方法如下:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Create implements storage.Interface.Create.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>store</span><span class=p>)</span> <span class=nf>Create</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>obj</span><span class=p>,</span> <span class=nx>out</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>,</span> <span class=nx>ttl</span> <span class=kt>uint64</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
	<span class=k>if</span> <span class=nx>version</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>versioner</span><span class=p>.</span><span class=nf>ObjectResourceVersion</span><span class=p>(</span><span class=nx>obj</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>version</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;resourceVersion should not be set on objects to be created&#34;</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>versioner</span><span class=p>.</span><span class=nf>PrepareObjectForStorage</span><span class=p>(</span><span class=nx>obj</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;PrepareObjectForStorage failed: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>codec</span><span class=p>,</span> <span class=nx>obj</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=nx>key</span> <span class=p>=</span> <span class=nx>path</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>pathPrefix</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>

	<span class=nx>opts</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>ttlOpts</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>ttl</span><span class=p>))</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=nx>newData</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>transformer</span><span class=p>.</span><span class=nf>TransformToStorage</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nf>authenticatedDataString</span><span class=p>(</span><span class=nx>key</span><span class=p>))</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>storage</span><span class=p>.</span><span class=nf>NewInternalError</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
	<span class=p>}</span>

	<span class=nx>startTime</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
	<span class=nx>txnResp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>KV</span><span class=p>.</span><span class=nf>Txn</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>If</span><span class=p>(</span>
		<span class=nf>notFound</span><span class=p>(</span><span class=nx>key</span><span class=p>),</span>
	<span class=p>).</span><span class=nf>Then</span><span class=p>(</span>
		<span class=nx>clientv3</span><span class=p>.</span><span class=nf>OpPut</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>newData</span><span class=p>),</span> <span class=nx>opts</span><span class=o>...</span><span class=p>),</span>
	<span class=p>).</span><span class=nf>Commit</span><span class=p>()</span>
	<span class=nx>metrics</span><span class=p>.</span><span class=nf>RecordEtcdRequestLatency</span><span class=p>(</span><span class=s>&#34;create&#34;</span><span class=p>,</span> <span class=nf>getTypeName</span><span class=p>(</span><span class=nx>obj</span><span class=p>),</span> <span class=nx>startTime</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=p>!</span><span class=nx>txnResp</span><span class=p>.</span><span class=nx>Succeeded</span> <span class=p>{</span>
		<span class=k>return</span> <span class=nx>storage</span><span class=p>.</span><span class=nf>NewKeyExistsError</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=k>if</span> <span class=nx>out</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>putResp</span> <span class=o>:=</span> <span class=nx>txnResp</span><span class=p>.</span><span class=nx>Responses</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nf>GetResponsePut</span><span class=p>()</span>
		<span class=k>return</span> <span class=nf>decode</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>codec</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>versioner</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>out</span><span class=p>,</span> <span class=nx>putResp</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nx>Revision</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>主要操作为：
1、调用<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apimachinery/pkg/runtime/codec.go#L47>Encode</a>方法序列化；
2、调用<code>path.Join</code>解析Key；
3、调用<a href=https://github.com/kubernetes/kubernetes/blob/v1.18.4/staging/src/k8s.io/apiserver/pkg/storage/value/transformer.go#L48>TransformToStorage</a>将数据类型进行转换；
4、调用客户端方法进行etcd的写入操作。
至此，完成handler处理与对应的etcd数据库操作的绑定，即完成整个路由后端的操作步骤。</p>
<p>参考：</p>
<ul>
<li><a href=https://github.com/kubernetes/kubernetes>https://github.com/kubernetes/kubernetes</a></li>
<li><a href=https://juejin.im/post/5c934e5a5188252d7c216981>https://juejin.im/post/5c934e5a5188252d7c216981</a></li>
</ul>
<div class=blog-tags>
<a href=https://xyslion.github.io//tags/k8s/>k8s</a>&nbsp;
<a href=https://xyslion.github.io//tags/apiserver/>apiserver</a>&nbsp;
</div>
</article>
<ul class="pager blog-pager">
<li class=previous>
<a href=https://xyslion.github.io/notes/mysql_index/ data-toggle=tooltip data-placement=top title=两个SQL查询引发的mysql索引学习>&larr; 前一篇</a>
</li>
<li class=next>
<a href=https://xyslion.github.io/notes/hugo-note/ data-toggle=tooltip data-placement=top title="利用 GitHub Pages, Hugo, Markdown 搭建个人笔记博客">后一篇 &rarr;</a>
</li>
</ul>
</div>
</div>
</div>
<footer>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<ul class="list-inline text-center footer-links">
<li>
<a href=mailto:xiaoyulion@gmail.com title="Email me">
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
</ul>
<p class="credits copyright text-muted">
钰
&nbsp;&bull;&nbsp;&copy;
2021
&nbsp;&bull;&nbsp;
<a href=https://xyslion.github.io/>钰的笔记屋</a>
</p>
<p class="credits theme-by text-muted">
由 <a href=https://gohugo.io>Hugo v0.90.1</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> 移植自 <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=5ddc0785a77fcd2f09fbeeb929341c0e20e6b3ee>5ddc0785</a>]
</p>
</div>
</div>
</div>
</footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://xyslion.github.io/js/main.js></script>
<script src=https://xyslion.github.io/js/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script>
<script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://xyslion.github.io/js/load-photoswipe.js></script>
</body>
</html>